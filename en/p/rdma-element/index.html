<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="This article is reprinted from Zhihu Column: 3. Basic Elements of RDMA, author: Savir. When discussing the RDMA protocol, various abbreviations are unavoidable. Unlike the original IB protocol, this article provides a simple and straightforward introduction to the most important queue concepts in RDMA, making it easier for readers to understand."><title>RDMA Basic Elements</title>
<link rel=canonical href=https://cuterwrite.top/en/p/rdma-element/><link rel=stylesheet href=/scss/style.min.e82b84120b43b340665e4b3c6b625144c63ea87ec3a8572acc62bbd314e4204b.css><meta property='og:title' content="RDMA Basic Elements"><meta property='og:description' content="This article is reprinted from Zhihu Column: 3. Basic Elements of RDMA, author: Savir. When discussing the RDMA protocol, various abbreviations are unavoidable. Unlike the original IB protocol, this article provides a simple and straightforward introduction to the most important queue concepts in RDMA, making it easier for readers to understand."><meta property='og:url' content='https://cuterwrite.top/en/p/rdma-element/'><meta property='og:site_name' content="Cuterwrite's Blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='RDMA'><meta property='article:tag' content='计算机网络'><meta property='article:tag' content='转载'><meta property='article:published_time' content='2024-02-02T01:01:01+00:00'><meta property='article:modified_time' content='2024-02-02T01:01:01+00:00'><meta property='og:image' content='https://cloud.cuterwrite.fun/img/73c30b990886bf6988c97858a3e16011195413_crop-2024-02-04.webp'><meta name=twitter:title content="RDMA Basic Elements"><meta name=twitter:description content="This article is reprinted from Zhihu Column: 3. Basic Elements of RDMA, author: Savir. When discussing the RDMA protocol, various abbreviations are unavoidable. Unlike the original IB protocol, this article provides a simple and straightforward introduction to the most important queue concepts in RDMA, making it easier for readers to understand."><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://cloud.cuterwrite.fun/img/73c30b990886bf6988c97858a3e16011195413_crop-2024-02-04.webp'><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><script async src=https://analytics.cuterwrite.top/uma.js data-website-id=b13594a2-4d15-4a4e-a020-5e3cc1d88c12 data-domains=cuterwrite.top></script><link rel=manifest href=/manifest.json></head><body class="article-page
line-numbers"><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/en/><img src=/img/avatar_hu7627246953874065940.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>😉</span></figure><div class=site-meta><h1 class=site-name><a href=/en>Cuterwrite's Blog</a></h1><h2 class=site-description>Cuterwrite's tech blog, focusing on in-depth exploration and experience sharing in areas such as high-performance computing, operating systems, full-stack development, and artificial intelligence.</h2></div></header><ol class=menu-social><li><a href=https://analytics.cuterwrite.top/share/Ji0gm9OaLDk8gco7 target=_blank title=Analytics rel=me><svg width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 5H7A2 2 0 005 7v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="2"/><path d="M9 17v-5"/><path d="M12 17v-1"/><path d="M15 17v-3"/></svg></a></li><li><a href=https://stats.uptimerobot.com/6NVhRHkSAQ target=_blank title=Uptime rel=me><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-chart-line"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 19h16"/><path d="M4 15l4-6 4 2 4-5 4 4"/></svg></a></li><li><a href=/index.xml target=_blank title=RSS rel=me><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li><li><a href=https://github.com/PKUcoldkeyboard target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://www.zhihu.com/people/kong-tiao-cheng-tai-lang-30-57 target=_blank title=zhihu rel=me><svg t="1705591931290" class="icon" viewBox="0 0 1280 1024" p-id="21048" width="32" height="32"><path d="M341.08 296.26v435.08l46.86.02 15.42 52.74 84.02-52.74h99.06V296.26H341.08zm195.5 387.86H480.7l-55.8 35.02-10.16-34.94-23.8-.08V343.5h145.64v340.62zM299.66 495.34H195c3.48-54.2 4.4-103.18 4.4-146.92h102.32s3.94-45.12-17.16-44.62h-177c6.98-26.24 15.74-53.32 26.24-81.34.0.0-48.14.0-64.54 43.14-6.78 17.8-26.42 86.28-61.4 156.24 11.78-1.28 50.74-2.36 73.68-44.42 4.22-11.78 5.02-13.32 10.28-29.06h57.74c0 21-2.4 133.76-3.36 146.88H41.66c-23.48.0-31.12 47.24-31.12 47.24H141.7C132.9 642.2 85.66 726.24.0 792.68c40.98 11.7 81.82-1.86 102-19.8.0.0 45.96-41.8 71.18-138.5L281.1 764.26s15.82-53.78-2.48-79.98c-15.16-17.84-56.12-66.12-73.58-83.62L175.8 623.9c8.72-27.96 13.98-55.1 15.74-81.34h123.3s-.18-47.24-15.18-47.24v.02zm824.04-3.2c41.66-51.28 89.96-117.14 89.96-117.14s-37.3-29.6-54.76-8.12c-12 16.3-73.66 96.4-73.66 96.4l38.46 28.86zM823.52 373.96c-18.02-16.5-51.82 4.26-51.82 4.26s79.04 110.08 82.24 114.9l38.92-27.46s-51.34-75.22-69.32-91.72h-.02zM1280 516.7c-39.56.0-261.82 1.86-262.12 1.86v-202c9.62.0 24.84-.8 45.7-2.4 81.76-4.82 140.26-8 175.54-9.62.0.0 24.44-54.38-1.18-66.88-6.14-2.36-46.34 9.16-46.34 9.16s-330.44 32.98-464.72 36.1c3.2 17.64 15.24 34.16 31.56 39.1 26.62 6.96 45.38 3.4 98.3 1.78 49.66-3.2 87.36-4.86 113.02-4.86v199.62H702.82s5.64 44.62 51.02 45.7h215.88V706.1c0 27.94-22.38 43.98-48.96 42.24-28.16.22-52.16-2.3-83.38-3.62 3.98 7.94 12.66 28.78 38.62 43.68 19.76 9.62 32.34 13.14 52.04 13.14 59.12.0 91.34-34.56 89.78-90.62V564.28h244.72c19.36.0 17.4-47.56 17.4-47.56l.06-.02z" fill="#707070" p-id="21049"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/en/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>主页 | Home</span></a></li><li><a href=/en/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>关于 | About</span></a></li><li><a href=/en/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档 | Archives</span></a></li><li><a href=/en/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索 | Search</span></a></li><li><a href=https://gallery.cuterwrite.top target=_blank><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-album"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 4m0 2a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2z"/><path d="M12 4v7l2-2 2 2V4"/></svg>
<span>图册 | Gallery</span></a></li><li><a href=https://draw.cuterwrite.top target=_blank><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-artboard"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M8 8m0 1a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H9a1 1 0 01-1-1z"/><path d="M3 8h1"/><path d="M3 16h1"/><path d="M8 3v1"/><path d="M16 3v1"/><path d="M20 8h1"/><path d="M20 16h1"/><path d="M8 20v1"/><path d="M16 20v1"/></svg>
<span>画板 | Canvas</span></a></li><li><a href=https://it-tools.tech target=_blank><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-tools"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 21h4L20 8a1.5 1.5.0 00-4-4L3 17v4"/><path d="M14.5 5.5l4 4"/><path d="M12 8 7 3 3 7l5 5"/><path d="M7 8 5.5 9.5"/><path d="M16 12l5 5-4 4-5-5"/><path d="M16 17l-1.5 1.5"/></svg>
<span>工具 | Tools</span></a></li><li class=menu-bottom-section><ol class=menu><li id=i18n-switch><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg>
<select name=language title=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://cuterwrite.top/>中文</option><option value=https://cuterwrite.top/en/ selected>English</option></select></li><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ul><li><a href=#wq>WQ</a><ul><li><a href=#wqe>WQE</a></li><li><a href=#qp>QP</a></li><li><a href=#sq-and-rq>SQ and RQ</a></li><li><a href=#srq>SRQ</a></li></ul></li><li><a href=#cq>CQ</a></li><li><a href=#wr-and-wc>WR and WC</a></li><li><a href=#code-example>Code example</a></li><li><a href=#summary>Summary</a></li><li><a href=#references>References</a></li></ul></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/en/p/rdma-element/><img src=https://cloud.cuterwrite.fun/img/73c30b990886bf6988c97858a3e16011195413_crop-2024-02-04.webp loading=lazy alt="Featured image of post RDMA Basic Elements"></a></div><div class=article-details><header class=article-category><a href=/en/categories/hpc/ style=background-color:#ffb900;color:#fff>High Performance Computing</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/en/p/rdma-element/>RDMA Basic Elements</a></h2><h3 class=article-subtitle>This article is reprinted from Zhihu Column: 3. Basic Elements of RDMA, author: Savir. When discussing the RDMA protocol, various abbreviations are unavoidable. Unlike the original IB protocol, this article provides a simple and straightforward introduction to the most important queue concepts in RDMA, making it easier for readers to understand.</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2024-02-02</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>4 minute read</time></div><div><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-keyboard"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M2 6m0 2a2 2 0 012-2h16a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2z"/><path d="M6 10v.01"/><path d="M10 10v.01"/><path d="M14 10v.01"/><path d="M18 10v.01"/><path d="M6 14v.01"/><path d="M18 14v.01"/><path d="M10 14l4 .01"/></svg>
<time class=article-time--wordcount>1713 words</time></div></footer><footer class=article-translations><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg><div><a href=https://cuterwrite.top/p/rdma-element/ class=link>中文</a></div></footer></div></header><section class=article-content><h1 id=rdma-basic-elements><a href=#rdma-basic-elements class=header-anchor>#</a>
RDMA Basic Elements</h1><p><strong>This article welcomes non-commercial reprints, please indicate the source.</strong></p><blockquote><p>Statement: For collection only, for easy reading</p><span class=cite><span>― </span><span>Savir, </span><a href=https://zhuanlan.zhihu.com/p/141267386><cite>Zhihu Column: 3. Basic Elements of RDMA</cite></a></span></blockquote><p>In RDMA technology, abbreviations are often used, which can easily confuse newcomers. The purpose of this article is to explain the most basic elements in RDMA and their meanings.</p><p>I will write a table of common abbreviations at the front, so if you forget while reading, you can refer to it at the front.</p><figure><img src=https://cloud.cuterwrite.fun/img/v2-b6723caa5b291ee161d94fd8fd8ce09c_720w-2024-02-03.webp alt=v2-b6723caa5b291ee161d94fd8fd8ce09c_720w-2024-02-03 width=auto loading=lazy></figure><h2 id=wq><a href=#wq class=header-anchor>#</a>
WQ</h2><p>Work Queue, abbreviated as WQ, is one of the most important concepts in RDMA technology. WQ is a queue that stores work requests. To clearly explain what WQ is, we first introduce the elements in this queue, WQE (Work Queue Element).</p><h3 id=wqe><a href=#wqe class=header-anchor>#</a>
WQE</h3><p>WQE can be considered a &ldquo;task description,&rdquo; which is a work request issued by software to hardware. This description contains the tasks that the software hopes the hardware will perform, as well as detailed information about the task. For example, a task might be like this: &ldquo;I want to send data located at address 0x12345678 with a length of 10 bytes to the opposite node.&rdquo; After receiving the task, the hardware will use DMA to fetch the data from memory, assemble the data packet, and then send it.</p><p>The meaning of WQE should be quite clear, so what is the WQ we mentioned at the beginning? It is the &ldquo;folder&rdquo; used to store &ldquo;task documents,&rdquo; and the WQ can contain many WQEs. Readers with a basic understanding of data structures should know that a queue is a first-in-first-out data structure, which is very common in computer systems. We can use the diagram below to represent the relationship between WQ and WQE described above:</p><figure><img src=https://cloud.cuterwrite.fun/img/v2-40c7e57f2760323c6b6665306e8f8896_720w-2024-02-03.webp alt=v2-40c7e57f2760323c6b6665306e8f8896_720w-2024-02-03 width=auto loading=lazy></figure><p>WQ This queue is always added to by the software with WQE (enqueue), and the hardware extracts WQE from it, which is the process of the software &ldquo;issuing tasks&rdquo; to the hardware. Why use a queue instead of a stack? Because the &ldquo;store&rdquo; and &ldquo;retrieve&rdquo; operations are performed separately by software and hardware, and it is necessary to ensure that user requests are processed in order. In RDMA technology, all communication requests must be notified to the hardware in the manner shown in the above diagram, which is often referred to as &ldquo;Post&rdquo;.</p><h3 id=qp><a href=#qp class=header-anchor>#</a>
QP</h3><p>Queue Pair, abbreviated as QP, means &ldquo;a pair&rdquo; of WQ.</p><h3 id=sq-and-rq><a href=#sq-and-rq class=header-anchor>#</a>
SQ and RQ</h3><p>Any communication process must have both sending and receiving ends. A QP is a combination of a send work queue and a receive work queue, which are referred to as the SQ (Send Queue) and RQ (Receive Queue) respectively. Let&rsquo;s enrich the diagram above; the left side is the sending end, and the right side is the receiving end:</p><figure><img src=https://cloud.cuterwrite.fun/img/v2-b89b321b8d1ae5ab6dcbaf8d6085f107_720w-2024-02-03.webp alt=v2-b89b321b8d1ae5ab6dcbaf8d6085f107_720w-2024-02-03 width=auto loading=lazy></figure><p>Why is WQ missing? SQ and RQ are both WQ, WQ just represents a unit that can store WQE, SQ and RQ are the instances.</p><p>SQ is specifically used to store send tasks, and RQ is specifically used to store receive tasks. In a SEND-RECV process, the sender needs to place a WQE representing a send task into the SQ. Similarly, the receiver software needs to issue a WQE representing a receive task to the hardware so that the hardware knows where to place the received data in memory. The Post operation we mentioned earlier is called Post Send for SQ and Post Receive for RQ.</p><p>It should be noted that in RDMA technology, <strong>the basic unit of communication is QP</strong>, not the node. As shown in the figure below, for each node, each process can use several QPs, and each local QP can be &ldquo;associated&rdquo; with a remote QP. Saying &ldquo;Node A sends data to Node B&rdquo; is not sufficient to fully describe an RDMA communication; it should be more like &ldquo;QP3 on Node A sends data to QP4 on Node C.&rdquo;</p><figure><img src=https://cloud.cuterwrite.fun/img/v2-71b3b17ef8aec45d74ef9e4a42a69201_720w-2024-02-03.webp alt=v2-71b3b17ef8aec45d74ef9e4a42a69201_720w-2024-02-03 width=auto loading=lazy></figure><p>Each QP of every node has a unique number, called QPN (Queue Pair Number), which can uniquely identify a QP on a node.</p><h3 id=srq><a href=#srq class=header-anchor>#</a>
SRQ</h3><p>Shared Receive Queue, abbreviated as SRQ, means a shared receive queue. The concept is easy to understand; it refers to a situation where several QPs share the same RQ, which we call SRQ. We will later learn that the use of RQ is far less than the use of SQ, and each queue consumes memory resources. When we need to use a large number of QPs, we can save memory through SRQ. As shown in the figure below, QP2~QP4 use the same RQ together:</p><figure><img src=https://cloud.cuterwrite.fun/img/v2-4a21f2b1333877b4b0d97a1ca91d4096_720w-2024-02-03.webp alt=v2-4a21f2b1333877b4b0d97a1ca91d4096_720w-2024-02-03 width=auto loading=lazy></figure><h2 id=cq><a href=#cq class=header-anchor>#</a>
CQ</h2><p>Completion Queue, abbreviated as CQ, means completion queue. Similar to WQ, we first introduce the elements in the CQ queue — CQE (Completion Queue Element). CQE can be considered the opposite concept of WQE. If WQE is the &ldquo;task list&rdquo; issued by software to hardware, then CQE is the &ldquo;task report&rdquo; returned by hardware to software after completing the task. CQE describes whether a task was executed correctly or if an error was encountered, and if so, what the cause of the error was.</p><p>And CQ is the container that carries CQE—a first-in-first-out queue. If we invert the diagram representing the relationship between WQ and WQE, we get the relationship between CQ and CQE:</p><figure><img src=https://cloud.cuterwrite.fun/img/v2-31f9a407ab66381fbc557d8acc5573cb_720w-2024-02-03.webp alt=v2-31f9a407ab66381fbc557d8acc5573cb_720w-2024-02-03 width=auto loading=lazy></figure><p>Each CQE contains completion information for a certain WQE, and their relationship is shown in the diagram below:</p><figure><img src=https://cloud.cuterwrite.fun/img/v2-701fa8eacb10c90c45b0241c75254a01_720w-2024-02-03.webp alt=v2-701fa8eacb10c90c45b0241c75254a01_720w-2024-02-03 width=auto loading=lazy></figure><p>Below, we put CQ and WQ (QP) together to see the interaction between software and hardware in a single SEND-RECV operation (the order of numbers in the diagram does not represent the actual sequence):</p><blockquote><p>2022/5/23: The order of the diagram and the subsequent list has been modified. The original item 2 &ldquo;The receiving end hardware takes the task book from the RQ and prepares to receive data&rdquo; has been moved to after &ldquo;The receiving end receives data, verifies it, and then sends an ACK message back to the sender,&rdquo; and the description has been modified. It is now item 6.</p><p>The mistake I made here is that RQ and SQ are different; RQ is a &ldquo;passive reception&rdquo; process, and the hardware only consumes RQ WQE when it receives a Send packet (or a Write packet with an immediate value). Thanks to @连接改变世界 for the correction.</p></blockquote><figure><img src=https://cloud.cuterwrite.fun/img/v2-a8d38721903672037b27cc7e49ecee03_720w-2024-02-03.webp alt=v2-a8d38721903672037b27cc7e49ecee03_720w-2024-02-03 width=auto loading=lazy></figure><ol><li>The receiving end APP issues a RECV task to the RQ in the form of WQE.</li><li>The sending-end APP issues a SEND task to the SQ in the form of a WQE.</li><li>The sending-end hardware retrieves the task list from the SQ, obtains the data to be sent from memory, and assembles the data packet.</li><li>The sender&rsquo;s network card sends the data packet to the receiver&rsquo;s network card through the physical link.</li><li>After the receiving end receives the data and verifies it, it sends an ACK message back to the sending end.</li><li>The receiving-end hardware takes a work queue entry (WQE) from the RQ.</li><li>The receiving end hardware places the data in the location specified by the WQE, then generates a &ldquo;task report&rdquo; CQE, and places it in the CQ.</li><li>The receiving end APP obtains task completion information.</li><li>After the network card at the sending end receives the ACK, it generates a CQE and places it into the CQ.</li><li>The sending-end APP obtains task completion information.</li></ol><blockquote class="alert-blockquote alert-note"><p class=alert-heading><svg viewBox="0 0 16 16" width="16" height="16"><path d="M0 8a8 8 0 1116 0A8 8 0 010 8zm8-6.5a6.5 6.5.0 100 13 6.5 6.5.0 000-13zM6.5 7.75A.75.75.0 017.25 7h1a.75.75.0 01.75.75v2.75h.25a.75.75.0 010 1.5h-2a.75.75.0 010-1.5h.25v-2h-.25a.75.75.0 01-.75-.75zM8 6a1 1 0 110-2 1 1 0 010 2z"/></svg>
<span>Note</span></p><p>NOTE: One important point to note is that the example in the above diagram is the interaction flow of a reliable service type. If it is an unreliable service, there will be no ACK reply in step 5, and step 9 and subsequent steps will be triggered immediately after step 5. We will explain service types and the difference between reliable and unreliable in the article &ldquo;Basic RDMA Service Types.&rdquo;</p></blockquote><p>At this point, through the two media, WQ and CQ, both ends of the software and hardware have jointly completed a transmission and reception process.</p><h2 id=wr-and-wc><a href=#wr-and-wc class=header-anchor>#</a>
WR and WC</h2><p>After discussing several Queues, there are actually two concepts mentioned at the beginning of the article that have not been explained, namely WR and WC (not the abbreviation for Water Closet).</p><p>WR stands for Work Request; WC stands for Work Completion. These two are actually &ldquo;mappings&rdquo; of WQE and CQE at the user level. Since the APP completes RDMA communication by calling the protocol stack interface, WQE and CQE themselves are not visible to the user and are concepts within the driver. What the user actually submits through the API is WR, and what is received is WC.</p><p>WR/WC and WQE/CQE are the same concepts at different levels of entities, both being &ldquo;task book&rdquo; and &ldquo;task report&rdquo;. Therefore, we have added some content to the two diagrams mentioned earlier:</p><figure><img src=https://cloud.cuterwrite.fun/img/v2-00b87c111a8e1701f96fbfb78e078b29_720w-2024-02-03.webp alt=v2-00b87c111a8e1701f96fbfb78e078b29_720w-2024-02-03 width=auto loading=lazy></figure><h2 id=code-example><a href=#code-example class=header-anchor>#</a>
Code example</h2><p>Finally, below is a simple example demonstrating how to use libibverbs to create a QP and then send data through this QP. This is a very simple example, just to give readers an intuitive understanding of the concepts mentioned above.</p><pre><code class=language-c>#include &lt;infiniband/verbs.h&gt;

int main() {
    struct ibv_context *ctx;
    struct ibv_pd *pd;
    struct ibv_cq *cq;
    struct ibv_qp *qp;
    struct ibv_mr *mr;
    struct ibv_sge sge;
    struct ibv_send_wr wr;
    struct ibv_send_wr *bad_wr;
    struct ibv_wc wc;

    ctx = ibv_open_device();
    pd = ibv_alloc_pd(ctx);
    cq = ibv_create_cq(ctx, 100, NULL, NULL, 0);
    qp = ibv_create_qp(pd, NULL, NULL);
    mr = ibv_reg_mr(pd, buf, size, IBV_ACCESS_LOCAL_WRITE | IBV_ACCESS_REMOTE_WRITE);

    sge.addr = (uintptr_t)buf;
    sge.length = size;
    sge.lkey = mr-&gt;lkey;

    wr.wr_id = 1;
    wr.sg_list = &amp;sge;
    wr.num_sge = 1;
    wr.opcode = IBV_WR_SEND;
    wr.send_flags = IBV_SEND_SIGNALED;
    wr.next = NULL;

    ibv_post_send(qp, &amp;wr, &amp;bad_wr);
    ibv_poll_cq(cq, 1, &amp;wc);

    return 0;
}
</code></pre><h2 id=summary><a href=#summary class=header-anchor>#</a>
Summary</h2><p>Alright, let&rsquo;s use Figure 11 from section 3.2.1 of the IB protocol[1] to summarize the content of this article:</p><figure><img src=https://cloud.cuterwrite.fun/img/v2-2107a9bf8230c45ad73aa5ff0b8626ff_720w-2024-02-03.webp alt=v2-2107a9bf8230c45ad73aa5ff0b8626ff_720w-2024-02-03 width=auto loading=lazy></figure><p>The user-mode WR is converted by the driver into a WQE and filled into the WQ. The WQ can be an SQ responsible for sending or an RQ responsible for receiving. The hardware will take out the WQE from each WQ and complete the sending or receiving task according to the requirements in the WQE. After the task is completed, a CQE will be generated for this task and filled into the CQ. The driver will take out the CQE from the CQ and convert it into a WC to return to the user.</p><p>The introduction to the basic concepts ends here. The next article will introduce several common types of RDMA operations.</p><h2 id=references><a href=#references class=header-anchor>#</a>
References</h2><p>[1] &ldquo;IB Specification Vol 1-Release-1.3-2015-03-03&rdquo;</p></section><footer class=article-footer><section class=article-tags><a href=/en/tags/rdma/>RDMA</a>
<a href=/en/tags/computer-network/>Computer Networks</a>
<a href=/en/tags/repost/>Reprint</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer><script type=text/javascript src=/js/prism.js async></script></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/en/p/rdma-memory-window/><div class=article-image><img src=https://cloud.cuterwrite.fun/img/2024-06-16_116373724_p0_master1200.webp loading=lazy data-key=rdma-memory-window data-hash=https://cloud.cuterwrite.fun/img/2024-06-16_116373724_p0_master1200.webp></div><div class=article-details><h2 class=article-title>RDMA: Memory Window</h2></div></a></article><article class=has-image><a href=/en/p/rdma-shared-receive-queue/><div class=article-image><img src=https://cloud.cuterwrite.fun/img/2024-06-16_116373922_p0_master1200.webp loading=lazy data-key=rdma-shared-receive-queue data-hash=https://cloud.cuterwrite.fun/img/2024-06-16_116373922_p0_master1200.webp></div><div class=article-details><h2 class=article-title>RDMA: Shared Receive Queue</h2></div></a></article><article class=has-image><a href=/en/p/rdma-completion-queue/><div class=article-image><img src=https://cloud.cuterwrite.fun/img/2024-06-16_116903369_p0_master1200.webp loading=lazy data-key=rdma-completion-queue data-hash=https://cloud.cuterwrite.fun/img/2024-06-16_116903369_p0_master1200.webp></div><div class=article-details><h2 class=article-title>RDMA: Completion Queue</h2></div></a></article><article class=has-image><a href=/en/p/rdma-queue-pair/><div class=article-image><img src=https://cloud.cuterwrite.fun/img/2024-06-16_116342820_p0_master1200.webp loading=lazy data-key=rdma-queue-pair data-hash=https://cloud.cuterwrite.fun/img/2024-06-16_116342820_p0_master1200.webp></div><div class=article-details><h2 class=article-title>RDMA: Queue Pair</h2></div></a></article><article class=has-image><a href=/en/p/rdma-address-handle/><div class=article-image><img src=https://cloud.cuterwrite.fun/img/2024-06-16_116373922_p9_master1200.webp loading=lazy data-key=rdma-address-handle data-hash=https://cloud.cuterwrite.fun/img/2024-06-16_116373922_p9_master1200.webp></div><div class=article-details><h2 class=article-title>RDMA: Address Handle</h2></div></a></article></div></div></aside><script src=https://unpkg.com/twikoo@1.6.39/dist/twikoo.all.min.js></script><div id=tcomment></div><style>.twikoo{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}:root[data-scheme=dark]{--twikoo-body-text-color-main:rgba(255, 255, 255, 0.9);--twikoo-body-text-color:rgba(255, 255, 255, 0.7)}.twikoo .el-input-group__prepend,.twikoo .tk-action-icon,.twikoo .tk-time,.twikoo .tk-comments-count{color:var(--twikoo-body-text-color)}.twikoo .el-input__inner,.twikoo .el-textarea__inner,.twikoo .tk-preview-container,.twikoo .tk-content,.twikoo .tk-nick,.twikoo .tk-send{color:var(--twikoo-body-text-color-main)}.twikoo .el-button{color:var(--twikoo-body-text-color)!important}.OwO .OwO-body{background-color:var(--body-background)!important;color:var(--body-text-color)!important}</style><script>twikoo.init({envId:"https://comment.cuterwrite.top",el:"#tcomment",lang:"zh-CN"})</script><footer class=site-footer><section class=copyright>&copy;
2021 -
2024 cuterwrite</section><section class=running-time>本博客已稳定运行
<span id=runningdays class=running-days></span><br>总访客数：
<span id=busuanzi_value_site_uv class=running-days>Loading</span><br>总访问量：
<span id=busuanzi_value_site_pv class=running-days>Loading</span></section><section class=totalcount>发表了
<span class=running-days>25</span> 篇文章 ·
总计
<span class=running-days>60.67k</span> 字</section><section class=powerby><hr>Built with <b><a style=color:#9e8f9f href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a></b><br>Theme <b><a style=color:#9e8f9f href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.27.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a><br><span>基于 <a href=https://github.com/CaiJimmy/hugo-theme-stack/tree/v3.27.0 target=_blank rel=noopener><b style=color:#9e8f9f>v3.27.0</b></a> 分支版本修改</span><br></section></footer><script>let s1="2021-4-17";s1=new Date(s1.replace(/-/g,"/"));let s2=new Date,timeDifference=s2.getTime()-s1.getTime(),days=Math.floor(timeDifference/(1e3*60*60*24)),hours=Math.floor(timeDifference%(1e3*60*60*24)/(1e3*60*60)),minutes=Math.floor(timeDifference%(1e3*60*60)/(1e3*60)),result=days+"天"+hours+"小时"+minutes+"分钟";document.getElementById("runningdays").innerHTML=result</script><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://libs.jshub.com/photoswipe/4.1.3/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://libs.jshub.com/photoswipe/4.1.3/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://libs.jshub.com/photoswipe/4.1.3/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://libs.jshub.com/photoswipe/4.1.3/photoswipe.min.css crossorigin=anonymous></main></div><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.font.im/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><meta name=apple-mobile-web-app-capable content="yes"><meta name=theme-color content="#ffffff"><script>"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").then(e=>{console.log("Service worker registered with scope: ",e.scope)},e=>{console.log("Service worker registration failed: ",e)})})</script><script defer src=https://cn.vercount.one/js></script></body></html>