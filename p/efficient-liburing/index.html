<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="æœ¬æ–‡ä»‹ç»äº†é«˜æ€§èƒ½å¼‚æ­¥ I/O æ¡†æ¶ io_uring çš„åŸç†ã€æ ¸å¿ƒæ•°æ®ç»“æ„å’Œä½¿ç”¨ç¤ºä¾‹ã€‚é¦–å…ˆï¼Œæ–‡ç« å¯¹æ¯”äº† Linux åŸç”Ÿ aio æ¥å£å’Œ io_uring æ¥å£ï¼Œå¹¶ä»‹ç»äº† liburing åº“ã€‚æ¥ç€ï¼Œè¯¦ç»†è§£é‡Šäº† io_uring çš„æ ¸å¿ƒæ•°æ®ç»“æ„å’Œä¸‰ç§å·¥ä½œæ¨¡å¼ï¼Œä»¥åŠç³»ç»Ÿè°ƒç”¨ API å’Œé«˜çº§ç‰¹æ€§ã€‚ç„¶åï¼Œæ–‡ç« æä¾›äº†åœ¨é¡¹ç›®ä¸­å¼•å…¥ liburing çš„æ–¹æ³•ï¼Œå¹¶ç»™å‡ºäº†ä»£ç ç¤ºä¾‹å’Œæœ€ä½³å®è·µã€‚æœ€åï¼Œæ–‡ç« æ€»ç»“äº† io_uring çš„ä¼˜ç‚¹å’Œç»“è®ºã€‚"><title>é«˜æ€§èƒ½å¼‚æ­¥ I/O æ¡†æ¶ï¼šio_uring</title><link rel=canonical href=https://cuterwrite.top/p/efficient-liburing/><link rel=stylesheet href=/scss/style.min.a12f6d9475ee73ef9c178bbeaa53a124a4b4932c2611bf01f2801729abfd2d8c.css><meta property="og:title" content="é«˜æ€§èƒ½å¼‚æ­¥ I/O æ¡†æ¶ï¼šio_uring"><meta property="og:description" content="æœ¬æ–‡ä»‹ç»äº†é«˜æ€§èƒ½å¼‚æ­¥ I/O æ¡†æ¶ io_uring çš„åŸç†ã€æ ¸å¿ƒæ•°æ®ç»“æ„å’Œä½¿ç”¨ç¤ºä¾‹ã€‚é¦–å…ˆï¼Œæ–‡ç« å¯¹æ¯”äº† Linux åŸç”Ÿ aio æ¥å£å’Œ io_uring æ¥å£ï¼Œå¹¶ä»‹ç»äº† liburing åº“ã€‚æ¥ç€ï¼Œè¯¦ç»†è§£é‡Šäº† io_uring çš„æ ¸å¿ƒæ•°æ®ç»“æ„å’Œä¸‰ç§å·¥ä½œæ¨¡å¼ï¼Œä»¥åŠç³»ç»Ÿè°ƒç”¨ API å’Œé«˜çº§ç‰¹æ€§ã€‚ç„¶åï¼Œæ–‡ç« æä¾›äº†åœ¨é¡¹ç›®ä¸­å¼•å…¥ liburing çš„æ–¹æ³•ï¼Œå¹¶ç»™å‡ºäº†ä»£ç ç¤ºä¾‹å’Œæœ€ä½³å®è·µã€‚æœ€åï¼Œæ–‡ç« æ€»ç»“äº† io_uring çš„ä¼˜ç‚¹å’Œç»“è®ºã€‚"><meta property="og:url" content="https://cuterwrite.top/p/efficient-liburing/"><meta property="og:site_name" content="cuterwrite"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="AIO"><meta property="article:tag" content="Linux-å†…æ ¸"><meta property="article:published_time" content="2023-08-01T01:00:00+00:00"><meta property="article:modified_time" content="2023-08-01T01:00:00+00:00"><meta property="og:image" content="https://cuterwrite-1302252842.file.myqcloud.com/blog/20230801145236.webp"><meta name=twitter:title content="é«˜æ€§èƒ½å¼‚æ­¥ I/O æ¡†æ¶ï¼šio_uring"><meta name=twitter:description content="æœ¬æ–‡ä»‹ç»äº†é«˜æ€§èƒ½å¼‚æ­¥ I/O æ¡†æ¶ io_uring çš„åŸç†ã€æ ¸å¿ƒæ•°æ®ç»“æ„å’Œä½¿ç”¨ç¤ºä¾‹ã€‚é¦–å…ˆï¼Œæ–‡ç« å¯¹æ¯”äº† Linux åŸç”Ÿ aio æ¥å£å’Œ io_uring æ¥å£ï¼Œå¹¶ä»‹ç»äº† liburing åº“ã€‚æ¥ç€ï¼Œè¯¦ç»†è§£é‡Šäº† io_uring çš„æ ¸å¿ƒæ•°æ®ç»“æ„å’Œä¸‰ç§å·¥ä½œæ¨¡å¼ï¼Œä»¥åŠç³»ç»Ÿè°ƒç”¨ API å’Œé«˜çº§ç‰¹æ€§ã€‚ç„¶åï¼Œæ–‡ç« æä¾›äº†åœ¨é¡¹ç›®ä¸­å¼•å…¥ liburing çš„æ–¹æ³•ï¼Œå¹¶ç»™å‡ºäº†ä»£ç ç¤ºä¾‹å’Œæœ€ä½³å®è·µã€‚æœ€åï¼Œæ–‡ç« æ€»ç»“äº† io_uring çš„ä¼˜ç‚¹å’Œç»“è®ºã€‚"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://cuterwrite-1302252842.file.myqcloud.com/blog/20230801145236.webp"><link rel="shortcut icon" href=/favicon.ico></head><body class="article-page
line-numbers"><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ¢èœå•>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hue4d14694a57c01a222a16c47db12c89c_369633_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>ğŸ˜‰</span></figure><div class=site-meta><h1 class=site-name><a href=/>cuterwrite</a></h1><h2 class=site-description>æ¬¢è¿æ¥åˆ°æˆ‘çš„ä¸ªäººåšå®¢ã€‚æˆ‘æ˜¯cuterwriteï¼Œä¸€ä¸ªçƒ­çˆ±ç”Ÿæ´»ã€ä¸æ–­æ¢ç´¢çš„äººã€‚åœ¨è¿™é‡Œï¼Œæˆ‘åˆ†äº«æˆ‘çš„æƒ³æ³•ã€ç»éªŒå’Œå­¦ä¹ ï¼Œå¸Œæœ›å¯ä»¥å¸®åŠ©åˆ°ä½ ï¼Œä¹Ÿæ¬¢è¿ä½ ä¸æˆ‘åˆ†äº«ä½ çš„çœ‹æ³•ã€‚</h2></div></header><ol class=social-menu><li><a href=https://github.com/PKUcoldkeyboard target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://cuterwrite.top/index.xml target=_blank title=rss rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li><li><a href=https://www.zhihu.com/people/kong-tiao-cheng-tai-lang-30-57 target=_blank title=zhihu rel=me><svg t="1705591931290" class="icon" viewBox="0 0 1280 1024" xmlns="http://www.w3.org/2000/svg" p-id="21048" width="32" height="32"><path d="M341.08 296.26v435.08l46.86.02 15.42 52.74 84.02-52.74h99.06V296.26H341.08zm195.5 387.86H480.7l-55.8 35.02-10.16-34.94-23.8-.08V343.5h145.64v340.62zM299.66 495.34H195c3.48-54.2 4.4-103.18 4.4-146.92h102.32s3.94-45.12-17.16-44.62h-177c6.98-26.24 15.74-53.32 26.24-81.34.0.0-48.14.0-64.54 43.14-6.78 17.8-26.42 86.28-61.4 156.24 11.78-1.28 50.74-2.36 73.68-44.42 4.22-11.78 5.02-13.32 10.28-29.06h57.74c0 21-2.4 133.76-3.36 146.88H41.66c-23.48.0-31.12 47.24-31.12 47.24H141.7C132.9 642.2 85.66 726.24.0 792.68c40.98 11.7 81.82-1.86 102-19.8.0.0 45.96-41.8 71.18-138.5L281.1 764.26s15.82-53.78-2.48-79.98c-15.16-17.84-56.12-66.12-73.58-83.62L175.8 623.9c8.72-27.96 13.98-55.1 15.74-81.34h123.3s-.18-47.24-15.18-47.24v.02zm824.04-3.2c41.66-51.28 89.96-117.14 89.96-117.14s-37.3-29.6-54.76-8.12c-12 16.3-73.66 96.4-73.66 96.4l38.46 28.86zM823.52 373.96c-18.02-16.5-51.82 4.26-51.82 4.26s79.04 110.08 82.24 114.9l38.92-27.46s-51.34-75.22-69.32-91.72h-.02zM1280 516.7c-39.56.0-261.82 1.86-262.12 1.86v-202c9.62.0 24.84-.8 45.7-2.4 81.76-4.82 140.26-8 175.54-9.62.0.0 24.44-54.38-1.18-66.88-6.14-2.36-46.34 9.16-46.34 9.16s-330.44 32.98-464.72 36.1c3.2 17.64 15.24 34.16 31.56 39.1 26.62 6.96 45.38 3.4 98.3 1.78 49.66-3.2 87.36-4.86 113.02-4.86v199.62H702.82s5.64 44.62 51.02 45.7h215.88V706.1c0 27.94-22.38 43.98-48.96 42.24-28.16.22-52.16-2.3-83.38-3.62 3.98 7.94 12.66 28.78 38.62 43.68 19.76 9.62 32.34 13.14 52.04 13.14 59.12.0 91.34-34.56 89.78-90.62V564.28h244.72c19.36.0 17.4-47.56 17.4-47.56l.06-.02z" fill="#707070" p-id="21049"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>ä¸»é¡µ | Home</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>å…³äº | About</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>å½’æ¡£ | Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>æœç´¢ | Search</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>æš—è‰²æ¨¡å¼</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">ç›®å½•</h2><div class=widget--toc><nav id=TableOfContents><ul><li><a href=#ä¸€-å¼•è¨€>ä¸€ã€ å¼•è¨€</a><ul><li><a href=#1-linux-åŸç”Ÿ-aio-æ¥å£>1. Linux åŸç”Ÿ aio æ¥å£</a></li><li><a href=#2-io_uring-æ¥å£>2. io_uring æ¥å£</a></li><li><a href=#3-liburing-åº“>3. liburing åº“</a></li></ul></li><li><a href=#äºŒio_uring-çš„æ ¸å¿ƒæ•°æ®ç»“æ„ä¸åŸç†>äºŒã€io_uring çš„æ ¸å¿ƒæ•°æ®ç»“æ„ä¸åŸç†</a><ul><li><a href=#1-io_uring-çš„æ ¸å¿ƒæ•°æ®ç»“æ„>1. io_uring çš„æ ¸å¿ƒæ•°æ®ç»“æ„</a></li><li><a href=#2-io_uring-çš„ä¸‰ç§å·¥ä½œæ¨¡å¼>2. io_uring çš„ä¸‰ç§å·¥ä½œæ¨¡å¼ï¼š</a></li><li><a href=#3-io_uring-çš„ç³»ç»Ÿè°ƒç”¨-api>3. io_uring çš„ç³»ç»Ÿè°ƒç”¨ API</a></li><li><a href=#4-io_uring-çš„é«˜çº§ç‰¹æ€§>4. io_uring çš„é«˜çº§ç‰¹æ€§</a></li></ul></li><li><a href=#ä¸‰io_uring-çš„ä½¿ç”¨ç¤ºä¾‹>ä¸‰ã€io_uring çš„ä½¿ç”¨ç¤ºä¾‹</a><ul><li><a href=#1-åœ¨é¡¹ç›®ä¸­å¼•å…¥-liburing>1. åœ¨é¡¹ç›®ä¸­å¼•å…¥ liburing</a></li><li><a href=#2-ä»£ç ç¤ºä¾‹>2. ä»£ç ç¤ºä¾‹</a></li><li><a href=#3-æœ€ä½³å®è·µ>3. æœ€ä½³å®è·µ</a></li></ul></li><li><a href=#ç»“è®º>ç»“è®º</a></li><li><a href=#å‚è€ƒæ–‡çŒ®>å‚è€ƒæ–‡çŒ®</a></li></ul></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/efficient-liburing/><img src=https://cuterwrite-1302252842.file.myqcloud.com/blog/20230801145236.webp loading=lazy alt="Featured image of post é«˜æ€§èƒ½å¼‚æ­¥ I/O æ¡†æ¶ï¼šio_uring"></a></div><div class=article-details><header class=article-category><a href=/categories/hpc/ style=background-color:#ffd06f;color:#fff>é«˜æ€§èƒ½è®¡ç®—</a>
<a href=/categories/techstack/ style=background-color:#376795;color:#fff>ç»¼åˆæŠ€æœ¯æ ˆ</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/efficient-liburing/>é«˜æ€§èƒ½å¼‚æ­¥ I/O æ¡†æ¶ï¼šio_uring</a></h2><h3 class=article-subtitle>æœ¬æ–‡ä»‹ç»äº†é«˜æ€§èƒ½å¼‚æ­¥ I/O æ¡†æ¶ io_uring çš„åŸç†ã€æ ¸å¿ƒæ•°æ®ç»“æ„å’Œä½¿ç”¨ç¤ºä¾‹ã€‚é¦–å…ˆï¼Œæ–‡ç« å¯¹æ¯”äº† Linux åŸç”Ÿ aio æ¥å£å’Œ io_uring æ¥å£ï¼Œå¹¶ä»‹ç»äº† liburing åº“ã€‚æ¥ç€ï¼Œè¯¦ç»†è§£é‡Šäº† io_uring çš„æ ¸å¿ƒæ•°æ®ç»“æ„å’Œä¸‰ç§å·¥ä½œæ¨¡å¼ï¼Œä»¥åŠç³»ç»Ÿè°ƒç”¨ API å’Œé«˜çº§ç‰¹æ€§ã€‚ç„¶åï¼Œæ–‡ç« æä¾›äº†åœ¨é¡¹ç›®ä¸­å¼•å…¥ liburing çš„æ–¹æ³•ï¼Œå¹¶ç»™å‡ºäº†ä»£ç ç¤ºä¾‹å’Œæœ€ä½³å®è·µã€‚æœ€åï¼Œæ–‡ç« æ€»ç»“äº† io_uring çš„ä¼˜ç‚¹å’Œç»“è®ºã€‚</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>2023-08-01</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>é˜…è¯»æ—¶é•¿: 16 åˆ†é’Ÿ</time></div></footer></div></header><section class=article-content><h1 id=é«˜æ€§èƒ½å¼‚æ­¥-io-æ¡†æ¶io_uring>é«˜æ€§èƒ½å¼‚æ­¥ I/O æ¡†æ¶ï¼šio_uring</h1><h2 id=ä¸€-å¼•è¨€>ä¸€ã€ å¼•è¨€</h2><h3 id=1-linux-åŸç”Ÿ-aio-æ¥å£>1. Linux åŸç”Ÿ aio æ¥å£</h3><p>åœ¨ Linux ä¸­ï¼Œæœ‰å¾ˆå¤šæ–¹æ³•å¯ä»¥è¿›è¡ŒåŸºäºæ–‡ä»¶çš„ I/Oã€‚æœ€æ—©çš„å’Œæœ€åŸºæœ¬çš„å°±æ˜¯ç³»ç»Ÿè°ƒç”¨ read(2)å’Œ write(2)ã€‚åæ¥å¢åŠ äº†å…è®¸ä¼ å…¥åç§»é‡çš„ pread(2)å’Œ pwrite(2)ï¼Œä»¥åŠåŸºäº vector çš„ preadv(2)å’Œ pwrite(2)ã€‚å†åæ¥ï¼ŒLinux æä¾›äº† preadv2(2)å’Œ pwritev2(2)ã€‚å®ƒä»¬è¿›ä¸€æ­¥æ‰©å±•äº† API ä»¥å…è®¸ä¿®é¥°ç¬¦æ ‡å¿—ã€‚æŠ›å¼€è¿™äº›ç³»ç»Ÿè°ƒç”¨çš„ä¸åŒç‚¹ä¸è°ˆï¼Œå®ƒä»¬æœ‰ä¸€ä¸ªå…±åŒçš„ç‰¹ç‚¹ï¼šéƒ½æ˜¯åŒæ­¥æ¥å£ã€‚è¿™æ„å‘³ç€å½“æ•°æ®å‡†å¤‡å¥½è¯»ï¼ˆæˆ–å†™å…¥ï¼‰æ—¶ï¼Œç³»ç»Ÿè°ƒç”¨æ‰ä¼šè¿”å›ã€‚å¯¹äºæŸäº›åœºæ™¯ï¼Œè¿™è¿œè¿œä¸å¤Ÿï¼Œå› æ­¤è¿˜éœ€è¦å¼‚æ­¥æ¥å£ã€‚POSIX æä¾›äº† aio_read(3)å’Œ aio_write(3)æ¥æ»¡è¶³è¿™ç§éœ€æ±‚ï¼Œä½†æ˜¯å®ƒä»¬çš„å®ç°é€šå¸¸æ€§èƒ½ä¸ä½³ã€‚Linux åŸç”Ÿ aio æ¥å£æ˜¯ Linux å†…æ ¸ä¸­æä¾›çš„ä¸€ç§å¼‚æ­¥ I/O æ¥å£ï¼Œå®ƒä½¿ç”¨ io_submit(2)ã€io_getevents(2)ç­‰ç³»ç»Ÿè°ƒç”¨æ¥æäº¤å’Œè·å– I/O è¯·æ±‚ï¼Œå¹¶ä½¿ç”¨ struct iocb æ¥æè¿°æ¯ä¸ª I/O è¯·æ±‚ã€‚å®ƒæ”¯æŒ O_DIRECTï¼ˆæˆ–éç¼“å†²ï¼‰è®¿é—®çš„å¼‚æ­¥ I/Oï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨ä¿¡å·æˆ–å›è°ƒå‡½æ•°æ¥é€šçŸ¥ I/O å®Œæˆäº‹ä»¶ã€‚</p><p>ç„¶è€Œï¼ŒLinux åŸç”Ÿ aio æ¥å£å­˜åœ¨ç€è®¸å¤šçš„é™åˆ¶ä¸ä¸è¶³ä¹‹å¤„ï¼š</p><ul><li>æœ€å¤§çš„é™åˆ¶æ˜¯å®ƒåªèƒ½æ”¯æŒ O_DIRECTï¼ˆæˆ–éç¼“å†²ï¼‰è®¿é—®çš„å¼‚æ­¥ I/Oã€‚ç”±äº O_DIRECT çš„é™åˆ¶ï¼ˆç¼“å­˜ç»•è¿‡å’Œå¤§å°/å¯¹é½é™åˆ¶ï¼‰ï¼Œè¿™ä½¿å¾—åŸç”Ÿ aio æ¥å£åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½æ— æ³•ä½¿ç”¨ã€‚å¯¹äºæ™®éçš„ç¼“å†² I/Oï¼Œæ¥å£ä¼šä»¥åŒæ­¥æ–¹å¼è¿è¡Œã€‚</li><li>å³ä½¿æ»¡è¶³äº† I/O å¼‚æ­¥çš„æ‰€æœ‰çº¦æŸæ¡ä»¶ï¼Œæœ‰æ—¶ä¹Ÿä¼šå‡ºç°é˜»å¡ã€‚I/O æäº¤å¯èƒ½ä¼šé€šè¿‡å¤šç§æ–¹å¼å¯¼è‡´é˜»å¡ï¼š<ol><li>å¦‚æœæ‰§è¡Œ I/O æ—¶éœ€è¦å…ƒæ•°æ®ï¼Œæäº¤å°±ä¼šé˜»å¡ï¼Œç­‰å¾…å…ƒæ•°æ®ã€‚</li><li>å¯¹äºå­˜å‚¨è®¾å¤‡ï¼Œæœ‰å›ºå®šæ•°é‡çš„è¯·æ±‚æ§½å¯ç”¨ã€‚å¦‚æœè¿™äº›æ’æ§½ç›®å‰éƒ½åœ¨ä½¿ç”¨ä¸­ï¼Œæäº¤å°±ä¼šé˜»å¡ï¼Œç­‰å¾…æœ‰ä¸€ä¸ªæ’æ§½å¯ç”¨ã€‚</li></ol></li><li>I/O è¯·æ±‚å…ƒæ•°æ®å¼€é”€å¤§ï¼šæ¯æ¬¡ I/O æäº¤éƒ½éœ€è¦å¤åˆ¶ 64 + 8 å­—èŠ‚çš„æ•°æ®ï¼Œè€Œæ¯æ¬¡å®Œæˆåˆ™éœ€è¦å¤åˆ¶ 32 å­—èŠ‚çš„æ•°æ®ã€‚è¿™æ„å‘³ç€å¯¹äºæ‰€è°“çš„é›¶æ‹·è´ I/O æ¥è¯´ï¼Œæ¯æ¬¡æ“ä½œéƒ½éœ€è¦å¤åˆ¶ 104 å­—èŠ‚çš„å†…å­˜ã€‚æ ¹æ® I/O çš„å¤§å°ä¸åŒï¼Œè¿™ç§å†…å­˜å¤åˆ¶çš„å¼€é”€å¯èƒ½æ˜¯æ˜æ˜¾å¯è§çš„ã€‚è€Œä¸”ï¼Œæš´éœ²çš„å®Œæˆäº‹ä»¶ç¯ç¼“å†²åŒºå®é™…ä¸Šä¼šå¦¨ç¢å®Œæˆæ“ä½œçš„é€Ÿåº¦ï¼Œå¹¶ä¸”å¾ˆéš¾ï¼ˆç”šè‡³ä¸å¯èƒ½ï¼‰ä»åº”ç”¨ç¨‹åºä¸­æ­£ç¡®åœ°ä½¿ç”¨ã€‚è¿™å¯èƒ½æ„å‘³ç€ä½¿ç”¨è¿™ä¸ª API è¿›è¡Œ I/O æ“ä½œæ—¶ï¼Œå®Œæˆæ“ä½œçš„æ•ˆç‡ä¼šå—åˆ°å½±å“ã€‚æ­¤å¤–ï¼Œåœ¨ Spectre/Meltdown æ¼æ´ä¿®å¤åï¼ŒI/O æ€»æ˜¯éœ€è¦è‡³å°‘ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ï¼ˆæäº¤+ç­‰å¾…å®Œæˆï¼‰ï¼Œè¿™ä¼šå¯¼è‡´ä¸¥é‡çš„æ€§èƒ½ä¸‹é™ã€‚è¿™å¯èƒ½æ˜¯å› ä¸ºåœ¨ä¿®å¤è¿™äº›æ¼æ´åï¼Œç³»ç»Ÿå¯¹äºç³»ç»Ÿè°ƒç”¨çš„å¤„ç†å˜å¾—æ›´åŠ å¤æ‚å’Œç¼“æ…¢ã€‚</li><li>IOPOLL æ”¯æŒä¸å¥½ã€‚</li></ul><p>éšç€æ—¶é—´çš„æ¨ç§»ï¼Œå°½ç®¡æœ‰ä¸€äº›åŠªåŠ›è¯•å›¾è§£å†³è¿™äº›é™åˆ¶ï¼Œä½†æ²¡æœ‰æˆåŠŸã€‚éšç€å…·å¤‡äºš 10 å¾®ç§’å»¶è¿Ÿå’Œéå¸¸é«˜ IOPS çš„è®¾å¤‡çš„å‡ºç°ï¼Œè¿™ä¸ªæ¥å£å¼€å§‹æ˜¾ç°å‡ºå…¶æ€§èƒ½ç¼ºé™·ã€‚å¯¹äºè¿™äº›ç±»å‹çš„è®¾å¤‡æ¥è¯´ï¼Œæ…¢é€Ÿå’Œéç¡®å®šæ€§çš„æäº¤å»¶è¿Ÿæ˜¯ä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜ï¼Œè€Œä¸”å•ä¸ªæ ¸å¿ƒæ— æ³•æä¾›è¶³å¤Ÿçš„æ€§èƒ½ã€‚æ­¤å¤–ï¼Œç”±äºå‰é¢æåˆ°çš„é™åˆ¶ï¼Œå¯ä»¥è¯´åŸç”Ÿçš„ Linux aio æ¥å£ç”¨é€”å¹¶ä¸å¹¿æ³›ã€‚å®ƒè¢«é™åˆ¶åœ¨åº”ç”¨ç¨‹åºçš„ä¸€å°éƒ¨åˆ†é¢†åŸŸä¸­ï¼Œå¹¶ä¸”ä¼´éšç€ä¸€äº›é—®é¢˜ã€‚</p><h3 id=2-io_uring-æ¥å£>2. io_uring æ¥å£</h3><p>io_uring æ˜¯ Linux å†…æ ¸ä¸­çš„ä¸€ç§æ–°çš„å¼‚æ­¥ I/O æ¥å£ï¼Œæ—¨åœ¨æä¾›é«˜æ•ˆå’Œå¯æ‰©å±•çš„ I/O æ“ä½œã€‚å®ƒé€šè¿‡ä½¿ç”¨ä¸€å¯¹ç¯å½¢é˜Ÿåˆ—ï¼ˆæäº¤é˜Ÿåˆ—å’Œå®Œæˆé˜Ÿåˆ—ï¼‰ä½œä¸ºåº”ç”¨ç¨‹åºå’Œå†…æ ¸ä¹‹é—´çš„é€šä¿¡é€šé“ï¼Œå®ç°äº†é›¶æ‹·è´çš„ I/O æ“ä½œã€‚</p><p>io_uring çš„è®¾è®¡ç›®æ ‡æ˜¯åœ¨æä¾›é«˜æ€§èƒ½çš„åŒæ—¶è§£å†³ä¼ ç»Ÿå¼‚æ­¥ I/O æ¥å£çš„ä¸€äº›é™åˆ¶å’Œé—®é¢˜ã€‚å®ƒé¿å…äº†å†…å­˜å¤åˆ¶å’Œå†…å­˜æ–¹å‘æ€§ï¼Œé€šè¿‡å…±äº«æ•°æ®ç»“æ„å’Œå†…å­˜æ¥ä¼˜é›…åœ°å®ç°åº”ç”¨ç¨‹åºå’Œå†…æ ¸ä¹‹é—´çš„åè°ƒã€‚è¿™ç§è®¾è®¡ä½¿å¾— io_uring èƒ½å¤Ÿæ›´é«˜æ•ˆåœ°å¤„ç† I/O è¯·æ±‚ï¼Œå¹¶ä¸”ä¸éœ€è¦é¢‘ç¹çš„ç³»ç»Ÿè°ƒç”¨æ¥åŒæ­¥å’Œé€šä¿¡ã€‚</p><p>é€šè¿‡ io_uringï¼Œåº”ç”¨ç¨‹åºå¯ä»¥ä½œä¸ºç”Ÿäº§è€…å°† I/O è¯·æ±‚æäº¤åˆ°æäº¤é˜Ÿåˆ—ï¼Œè€Œå†…æ ¸ä½œä¸ºæ¶ˆè´¹è€…å¤„ç†è¿™äº›è¯·æ±‚ã€‚ä¸€æ—¦è¯·æ±‚å®Œæˆï¼Œå†…æ ¸ä¼šç”Ÿæˆç›¸åº”çš„å®Œæˆäº‹ä»¶ï¼Œå¹¶å°†å…¶æ”¾å…¥å®Œæˆé˜Ÿåˆ—ä¸­ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥ä»å®Œæˆé˜Ÿåˆ—ä¸­æ¶ˆè´¹è¿™äº›äº‹ä»¶ã€‚è¿™ç§å¼‚æ­¥çš„æ–¹å¼ä½¿å¾—åº”ç”¨ç¨‹åºèƒ½å¤Ÿæ›´å¥½åœ°åˆ©ç”¨ç³»ç»Ÿèµ„æºï¼Œæé«˜ I/O æ“ä½œçš„æ•ˆç‡å’Œæ€§èƒ½ã€‚</p><p>io_uring çš„ä¼˜åŠ¿ä¸»è¦åœ¨äºï¼š</p><ul><li>ä½¿ç”¨æ–¹ä¾¿ï¼šç®€å•ä¸”å¼ºå¤§çš„ç³»ç»Ÿè°ƒç”¨ï¼Œæä¾›ä¸‰ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œliburing ç”¨æˆ·æ€åº“ç¼–ç¨‹å‹å¥½ (io_uring_setup, io_uring_enter, io_uring_register)ã€‚</li><li>é€šç”¨æ€§å¼ºï¼šæä¾›å†…æ ¸ç»Ÿä¸€çš„å¼‚æ­¥ç¼–ç¨‹æ¡†æ¶ï¼Œæ—¢æ”¯æŒä¼ ç»Ÿ I/O (Buffer I/O + Direct I/O)ï¼Œä¹Ÿæ”¯æŒç±» epoll å‹ç¼–ç¨‹ã€‚</li><li>ç‰¹æ€§ä¸°å¯Œï¼šæ”¯æŒéå¸¸å¤šçš„é«˜çº§ç‰¹æ€§ã€‚</li><li>é«˜æ€§èƒ½ï¼šI/O è¯·æ±‚ overhead å°ã€‚</li></ul><h3 id=3-liburing-åº“>3. liburing åº“</h3><p>liburing æ˜¯ä¸€ä¸ªåŸºäº io_uring æ¥å£çš„ç”¨æˆ·ç©ºé—´åº“ï¼Œå®ƒæ˜¯ Linux å†…æ ¸å¼€å‘è€… Axboe äº 2019 å¹´å‘å¸ƒçš„ä¸€ä¸ªå¼€æºé¡¹ç›®ã€‚io_uring æ˜¯ä¸€ç§æ–°çš„ Linux å¼‚æ­¥ I/O æ¥å£ï¼Œå®ƒé€šè¿‡ä½¿ç”¨ä¸€å¯¹ç¯å½¢ç¼“å†²åŒºï¼ˆring bufferï¼‰æ¥å®ç°ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ä¹‹é—´çš„é€šä¿¡ï¼Œä»è€Œé¿å…äº†ä¼ ç»Ÿå¼‚æ­¥ I/O æ¥å£ï¼ˆå¦‚ AIOï¼‰æ‰€éœ€çš„ç³»ç»Ÿè°ƒç”¨ã€ä¿¡å·ã€å›è°ƒç­‰æœºåˆ¶ã€‚è¿™æ ·ï¼Œç”¨æˆ·ç©ºé—´å¯ä»¥ç›´æ¥å‘å†…æ ¸æäº¤ I/O è¯·æ±‚ï¼Œå¹¶ä»å†…æ ¸è·å– I/O ç»“æœï¼Œè€Œæ— éœ€ç­‰å¾…æˆ–åˆ‡æ¢ä¸Šä¸‹æ–‡ã€‚è¿™å¤§å¤§æé«˜äº†å¼‚æ­¥ I/O æ“ä½œçš„æ•ˆç‡å’Œæ€§èƒ½ã€‚</p><p>liburing æ˜¯å¯¹ io_uring æ¥å£çš„å°è£…å’Œæ‰©å±•ï¼Œå®ƒæä¾›äº†ä¸€å¥—ç®€æ´å’Œçµæ´»çš„ APIï¼Œè®©å¼€å‘è€…å¯ä»¥æ–¹ä¾¿åœ°ä½¿ç”¨ io_uring çš„åŠŸèƒ½ï¼Œè€Œæ— éœ€å…³å¿ƒåº•å±‚çš„ç»†èŠ‚å’Œå¤æ‚æ€§ã€‚liburing ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªç»„ä»¶ï¼š</p><ul><li>liburing.hï¼šå®šä¹‰äº† liburing åº“çš„ä¸»è¦æ•°æ®ç»“æ„å’Œå‡½æ•°</li><li>liburing.aï¼šæä¾›äº† liburing åº“çš„é™æ€é“¾æ¥ç‰ˆæœ¬</li><li>liburing.soï¼šæä¾›äº† liburing åº“çš„åŠ¨æ€é“¾æ¥ç‰ˆæœ¬</li><li>liburing/io_uring.hï¼šå®šä¹‰äº† io_uring æ¥å£ç›¸å…³çš„æ•°æ®ç»“æ„å’Œå¸¸é‡</li><li>liburing/compat.hï¼šæä¾›äº†ä¸€äº›å…¼å®¹æ€§ç›¸å…³çš„å®å®šä¹‰</li></ul><h2 id=äºŒio_uring-çš„æ ¸å¿ƒæ•°æ®ç»“æ„ä¸åŸç†>äºŒã€io_uring çš„æ ¸å¿ƒæ•°æ®ç»“æ„ä¸åŸç†</h2><figure><img src=https://cuterwrite-1302252842.file.myqcloud.com/blog/20230802172119.webp alt=20230802172119 width=90% loading=lazy></figure><h3 id=1-io_uring-çš„æ ¸å¿ƒæ•°æ®ç»“æ„>1. io_uring çš„æ ¸å¿ƒæ•°æ®ç»“æ„</h3><ul><li>æ¯ä¸ª io_uring å®ä¾‹éƒ½æœ‰ä¸¤ä¸ªç¯å½¢é˜Ÿåˆ—(ç§°ä¸º ring)ï¼Œåœ¨å†…æ ¸å’Œåº”ç”¨ç¨‹åºä¹‹é—´å…±äº«ï¼š<ol><li>æäº¤é˜Ÿåˆ—ï¼šsubmission queue( SQ )</li><li>å®Œæˆé˜Ÿåˆ—ï¼šcompletion queue( CQ )</li></ol></li></ul><figure><img src=https://cuterwrite-1302252842.file.myqcloud.com/blog/20230802000924.webp alt=20230802000924 width=90% loading=lazy></figure><ul><li>è¿™ä¸¤ä¸ªé˜Ÿåˆ—ï¼š<ol><li>éƒ½æ˜¯å•ç”Ÿäº§è€…ã€å•æ¶ˆè´¹è€…çš„é˜Ÿåˆ—ï¼Œsize ä¸º 2 çš„å¹‚æ¬¡æ–¹ã€‚</li><li>æä¾›æ— é”æ¥å£ï¼Œå†…éƒ¨ä½¿ç”¨å†…å­˜å±éšœæ¥è¿›è¡ŒåŒæ­¥ã€‚</li></ol></li><li>è¯·æ±‚æ—¶ï¼š<ol><li>åº”ç”¨åˆ›å»º SQ Entries (SQE)ï¼Œæ›´æ–° SQ tail</li><li>å†…æ ¸æ¶ˆè´¹ SQEï¼Œæ›´æ–° SQ head</li></ol></li><li>å®Œæˆåï¼š<ol><li>å†…æ ¸ä¸ºå®Œæˆçš„ä¸€ä¸ªæˆ–å¤šä¸ªè¯·æ±‚åˆ›å»º CQ Entries (CQE)ï¼Œæ›´æ–° CQ tail</li><li>åº”ç”¨æ¶ˆè´¹ CQEï¼Œæ›´æ–° CQ head</li><li>å®Œæˆäº‹ä»¶å¯èƒ½ä»¥ä»»æ„é¡ºåºåˆ°è¾¾ï¼Œåˆ°æ€»æ˜¯ä¸ç‰¹å®šçš„ SQE ç›¸å…³è”çš„</li><li>æ¶ˆè´¹ CQE è¿‡ç¨‹æ— éœ€åˆ‡æ¢å†…æ ¸æ€</li></ol></li><li>è¿™æ ·åšçš„å¥½å¤„åœ¨äºï¼š<ol><li>åŸæœ¬éœ€è¦å¤šæ¬¡ç³»ç»Ÿè°ƒç”¨ï¼Œç°åœ¨å˜æˆæ‰¹å¤„ç†ä¸€æ¬¡æäº¤</li><li>æ­¤å¤–ï¼Œio_uring ä½¿å¼‚æ­¥ I/O çš„ä½¿ç”¨åœºæ™¯ä¹Ÿä¸å†ä»…é™äºæ•°æ®åº“åº”ç”¨ï¼Œ æ™®é€šçš„éæ•°æ®åº“åº”ç”¨ä¹Ÿèƒ½ç”¨</li></ol></li></ul><h3 id=2-io_uring-çš„ä¸‰ç§å·¥ä½œæ¨¡å¼>2. io_uring çš„ä¸‰ç§å·¥ä½œæ¨¡å¼ï¼š</h3><ol><li>ä¸­æ–­é©±åŠ¨æ¨¡å¼ (interrupt-driven)<ul><li>é»˜è®¤æ¨¡å¼, å¯é€šè¿‡ io_uring_enter()æäº¤ I/O è¯·æ±‚ï¼Œç„¶åç›´æ¥æ£€æŸ¥ CQ çŠ¶æ€åˆ¤æ–­æ˜¯å¦å®Œæˆã€‚</li></ul></li><li>è½®è¯¢æ¨¡å¼ (polling)<ul><li>Busy waiting for I/O completionï¼Œè€Œä¸æ˜¯é€šè¿‡å¼‚æ­¥ IRQ(Interrupt Request)æ¥æ¥æ”¶é€šçŸ¥</li><li>è¿™ç§æ¨¡å¼éœ€è¦æ–‡ä»¶ç³»ç»Ÿå’Œå—è®¾å¤‡æ”¯æŒè½®è¯¢åŠŸèƒ½ã€‚ç›¸æ¯”ä¸­æ–­é©±åŠ¨æ¨¡å¼ï¼Œè¿™ç§æ–¹å¼å»¶è¿Ÿæ›´ä½ï¼Œä½†æ˜¯ CPU å ç”¨ç‡å¯èƒ½ä¼šæ›´é«˜ã€‚</li><li>ç›®å‰ï¼Œåªæœ‰æŒ‡å®šäº† O_DIRECT æ ‡å¿—æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦æ‰èƒ½ä½¿ç”¨è¿™ç§æ¨¡å¼ã€‚å½“ä¸€ä¸ªè¯»æˆ–å†™è¯·æ±‚æäº¤ç»™è½®è¯¢ä¸Šä¸‹æ–‡ä¹‹åï¼Œåº”ç”¨å¿…é¡»è°ƒç”¨ io_uring_enter()æ¥è½®è¯¢ CQ é˜Ÿåˆ—ï¼Œåˆ¤æ–­è¯·æ±‚æ˜¯å¦å®Œæˆã€‚</li><li>å¯¹äºä¸€ä¸ª io_uring å®ä¾‹æ¥è¯´ï¼Œä¸æ”¯æŒæ··åˆä½¿ç”¨è½®è¯¢å’Œéè½®è¯¢æ¨¡å¼ã€‚</li></ul></li><li>å†…æ ¸è½®è¯¢æ¨¡å¼ (kernel polling)<ul><li>è¿™ç§æ¨¡å¼ä¼šåˆ›å»ºä¸€ä¸ªå†…æ ¸çº¿ç¨‹æ¥æ‰§è¡Œ SQ çš„è½®è¯¢å·¥ä½œã€‚</li><li>ä½¿ç”¨è¿™ç§æ¨¡å¼çš„ io_uring å®ä¾‹ï¼Œåº”ç”¨æ— éœ€åˆ‡åˆ°å†…æ ¸æ€å°±èƒ½è§¦å‘ I/O æ“ä½œã€‚é€šè¿‡ SQ æ¥æäº¤ SQEï¼Œä»¥åŠç›‘æ§ CQ çš„å®ŒæˆçŠ¶æ€ï¼Œåº”ç”¨æ— éœ€ä»»ä½•ç³»ç»Ÿè°ƒç”¨ï¼Œå°±èƒ½æäº¤å’Œæ”¶å‰² I/Oã€‚</li><li>å¦‚æœå†…æ ¸çº¿ç¨‹çš„ç©ºé—²äº‹ä»¶è¶…è¿‡äº†ç”¨æˆ·çš„é…ç½®å€¼ï¼Œå®ƒä¼šé€šçŸ¥åº”ç”¨ï¼Œç„¶åè¿›å…¥ idle çŠ¶æ€ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œåº”ç”¨å¿…é¡»è°ƒç”¨ io_uring_enter()æ¥å”¤é†’å†…æ ¸çº¿ç¨‹ã€‚å¦‚æœ I/O ä¸€ç›´å¾ˆç¹å¿™ï¼Œå†…æ ¸çº¿ç¨‹æ˜¯ä¸ä¼š sleep çš„ã€‚</li></ul></li></ol><h3 id=3-io_uring-çš„ç³»ç»Ÿè°ƒç”¨-api>3. io_uring çš„ç³»ç»Ÿè°ƒç”¨ API</h3><ul><li><p>io_uring çš„ç³»ç»Ÿè°ƒç”¨ API æœ‰ä¸‰ä¸ªï¼Œåˆ†åˆ«æ˜¯ï¼š</p><ul><li>io_uring_setup(2)</li><li>io_uring_register(2)</li><li>io_uring_enter(2)</li></ul></li><li><p>é¦–å…ˆæ˜¯ io_uring_setup(2)ï¼š</p><pre><code class=language-c>int io_uring_setup(unsigned entries, struct io_uring_params *p);
</code></pre><ul><li>ç”¨äºåˆ›å»ºä¸€ä¸ª io_uring å®ä¾‹ï¼Œè¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œç”¨äºåç»­çš„ io_uring ç³»ç»Ÿè°ƒç”¨ã€‚</li><li>å‚æ•°ï¼š<ul><li>entriesï¼šSQ å’Œ CQ çš„å¤§å°ï¼Œå¿…é¡»æ˜¯ 2 çš„å¹‚æ¬¡æ–¹</li><li>paramsï¼šio_uring çš„å‚æ•°ï¼ŒåŒ…æ‹¬ flagsã€sq_thread_cpu ç­‰</li></ul></li><li>è¿”å›å€¼ï¼š<ul><li>æˆåŠŸï¼šè¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦</li><li>å¤±è´¥ï¼šè¿”å›-1ï¼Œå¹¶è®¾ç½® errno</li></ul></li><li>åˆ›å»ºä¸€ä¸ª SQ å’Œä¸€ä¸ª CQï¼Œå®ƒä»¬çš„å¤§å°éƒ½æ˜¯ entriesã€‚å¦‚æœ entries æ˜¯ 0ï¼Œé‚£ä¹ˆ SQ å’Œ CQ çš„å¤§å°éƒ½æ˜¯é»˜è®¤å€¼(4096)ã€‚SQ å’Œ CQ åœ¨åº”ç”¨å’Œå†…æ ¸ä¹‹é—´å…±äº«ï¼Œé¿å…äº†åœ¨åˆå§‹åŒ–å’Œå®Œæˆ I/O æ—¶æ‹·è´æ•°æ®</li></ul></li><li><p>io_uring_register(2)ï¼š</p><pre><code class=language-c>int io_uring_register(int fd, unsigned int opcode, const void *arg, unsigned int nr_args);
</code></pre><ul><li>æ³¨å†Œç”¨äºå¼‚æ­¥ I/O çš„æ–‡ä»¶æˆ–ç”¨æˆ·ç¼“å†²åŒºï¼Œä½¿å†…æ ¸èƒ½é•¿æ—¶é—´æŒæœ‰å¯¹è¯¥æ–‡ä»¶åœ¨å†…æ ¸å†…éƒ¨çš„æ•°æ®ç»“æ„å¼•ç”¨ï¼Œæˆ–åˆ›å»ºåº”ç”¨å†…å­˜çš„é•¿æœŸæ˜ å°„ï¼Œè¿™ä¸ªæ“ä½œåªä¼šåœ¨æ³¨å†Œæ—¶æ‰§è¡Œä¸€æ¬¡ï¼Œè€Œä¸æ˜¯æ¯ä¸ª I/O æ“ä½œéƒ½ä¼šå¤„ç†ï¼Œå› æ­¤å‡å°‘äº† per-I/O çš„ overhead å¼€é”€ã€‚</li><li>å‚æ•°ï¼š<ul><li>fdï¼šæ–‡ä»¶æè¿°ç¬¦</li><li>opcodeï¼šæ“ä½œç ï¼Œç”¨äºæŒ‡å®šæ³¨å†Œçš„ç±»å‹ï¼Œå¦‚ IORING_REGISTER_BUFFERSã€IORING_REGISTER_FILES ç­‰</li><li>argï¼šæŒ‡å‘ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªæŒ‡å‘ç”¨æˆ·ç¼“å†²åŒºæˆ–æ–‡ä»¶æè¿°ç¬¦çš„æŒ‡é’ˆ</li><li>nr_argsï¼šarg æ•°ç»„çš„å¤§å°</li></ul></li><li>è¿”å›å€¼ï¼š<ul><li>æˆåŠŸï¼šè¿”å› 0</li><li>å¤±è´¥ï¼šè¿”å›-1ï¼Œå¹¶è®¾ç½® errno</li></ul></li><li>æ³¨å†Œçš„ç¼“å†²åŒºå°†ä¼šè¢«é”å®šåˆ°å†…å­˜ä¸­ï¼Œå¹¶è®¡å…¥ç”¨æˆ·çš„ RLIMIT_MEMLOCK é™åˆ¶ã€‚å¦‚æœæ³¨å†Œçš„æ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼Œé‚£ä¹ˆå†…æ ¸ä¼šå¢åŠ å¯¹è¯¥æ–‡ä»¶çš„å¼•ç”¨è®¡æ•°ï¼Œç›´åˆ°åº”ç”¨è°ƒç”¨ io_uring_unregister(2)æ¥æ³¨é”€å®ƒã€‚</li><li>æ¯ä¸ªç¼“å†²åŒºæœ‰ 1GB çš„å¤§å°é™åˆ¶ã€‚</li><li>ç¼“å†²åŒºå¿…é¡»æ˜¯åŒ¿åçš„ã€éæ–‡ä»¶åç«¯çš„å†…å­˜ï¼Œä¾‹å¦‚ malloc(3)æˆ–å¸¦ MAP_ANONYMOUS æ ‡è¯†çš„ mmap(2)è¿”å›çš„å†…å­˜ã€‚</li><li>Huge pages ä¹Ÿæ˜¯æ”¯æŒçš„ã€‚æ•´ä¸ª Huge page éƒ½ä¼šè¢« pin åˆ°å†…æ ¸ï¼Œå³ä½¿åªä½¿ç”¨å…¶ä¸­ä¸€éƒ¨åˆ†ã€‚</li><li>å·²ç»æ³¨å†Œçš„ç¼“å†²åŒºæ— æ³•è°ƒæ•´å¤§å°ï¼Œæƒ³è°ƒæ•´åªèƒ½å…ˆ unregisterï¼Œå†é‡æ–°æ³¨å†Œã€‚</li></ul></li><li><p>io_uring_enter(2):</p><pre><code class=language-c>int io_uring_enter(unsigned int fd, unsigned int to_submit, unsigned int min_complete, unsigned int flags, sigset_t *sig);
</code></pre><ul><li>è¿™ä¸ªç³»ç»Ÿè°ƒç”¨ç”¨äºåˆå§‹åŒ–å’Œå®Œæˆï¼ˆinitiate and completeï¼‰I/Oï¼Œä½¿ç”¨å…±äº«çš„ SQ å’Œ CQã€‚å•æ¬¡è°ƒç”¨åŒæ—¶æ‰§è¡Œï¼š<ol><li>æäº¤æ–°çš„ I/O è¯·æ±‚</li><li>ç­‰å¾… I/O å®Œæˆ</li></ol></li><li>å‚æ•°ï¼š<ul><li>fdï¼šio_uring å®ä¾‹çš„æ–‡ä»¶æè¿°ç¬¦</li><li>to_submitï¼šSQ ä¸­æäº¤çš„ I/O è¯·æ±‚æ•°é‡</li><li>min_completeï¼šæœ€å°‘å®Œæˆçš„ I/O è¯·æ±‚æ•°é‡</li><li>flagsï¼šç”¨äºæŒ‡å®š I/O è¯·æ±‚çš„ç±»å‹ï¼Œå¦‚ IORING_ENTER_GETEVENTSã€IORING_ENTER_SQ_WAKEUP ç­‰</li><li>sigï¼šç”¨äºæŒ‡å®šä¿¡å·é›†ï¼Œå¦‚æœ flags æŒ‡å®šäº† IORING_ENTER_GETEVENTSï¼Œé‚£ä¹ˆ sig å¿…é¡»æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ä¿¡å·é›†</li></ul></li><li>åœ¨é»˜è®¤æ¨¡å¼ä¸‹ï¼Œå¦‚æœæŒ‡å®šäº† min_completeï¼Œé‚£ä¹ˆ io_uring_enter(2)ä¼šç­‰å¾…è‡³å°‘ min_complete ä¸ª I/O è¯·æ±‚å®Œæˆï¼Œç„¶åè¿”å›ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®š min_completeï¼Œé‚£ä¹ˆ io_uring_enter(2)ä¼šç­‰å¾… SQ ä¸­æ‰€æœ‰çš„ I/O è¯·æ±‚å®Œæˆï¼Œç„¶åè¿”å›ã€‚åœ¨ polling æ¨¡å¼ä¸‹ï¼Œå¦‚æœæŒ‡å®šäº† min_completeï¼Œå¦‚æœ min_complete ä¸º 0ï¼Œåˆ™è¦æ±‚å†…æ ¸è¿”å›å½“å‰ä»¥åŠå®Œæˆçš„æ‰€æœ‰ eventsï¼Œæ— é˜»å¡ï¼›å¦‚æœ min_complete å¤§äº 0ï¼Œå¦‚æœæœ‰äº‹ä»¶å®Œæˆï¼Œå†…æ ¸ä»ç„¶ç«‹å³è¿”å›ï¼›å¦‚æœæ²¡æœ‰å®Œæˆäº‹ä»¶ï¼Œå†…æ ¸ä¼š pollï¼Œç­‰å¾…æŒ‡å®šçš„æ¬¡æ•°å®Œæˆï¼Œæˆ–è€…è¿™ä¸ªè¿›ç¨‹çš„æ—¶é—´ç‰‡ç”¨å®Œã€‚</li></ul></li></ul><h3 id=4-io_uring-çš„é«˜çº§ç‰¹æ€§>4. io_uring çš„é«˜çº§ç‰¹æ€§</h3><ul><li>io_uring è¿˜æä¾›äº†ä¸€äº›ç”¨äºç‰¹æ®Šåœºæ™¯çš„é«˜çº§ç‰¹æ€§<ul><li>File registration(æ–‡ä»¶æ³¨å†Œ)ï¼šæ¯æ¬¡å‘èµ·ä¸€ä¸ªæŒ‡å®šæ–‡ä»¶æè¿°çš„æ“ä½œï¼Œå†…æ ¸éƒ½éœ€è¦èŠ±è´¹ä¸€äº›æ—¶é’Ÿå‘¨æœŸ(cycles)æ–‡ä»¶æè¿°ç¬¦æ˜ å°„åˆ°å†…éƒ¨è¡¨ç¤ºã€‚å¯¹äºé‚£äº› <strong>é’ˆå¯¹åŒä¸€æ–‡ä»¶è¿›è¡Œé‡å¤æ“ä½œ</strong> çš„åœºæ™¯ï¼Œio_uring æ”¯æŒæå‰æ³¨å†Œè¿™äº›æ–‡ä»¶ï¼Œåé¢ç›´æ¥æŸ¥æ‰¾å°±è¡Œäº†ã€‚</li><li>Buffer registration(ç¼“å†²åŒºæ³¨å†Œ)ï¼šä¸ file registration ç±»ä¼¼ï¼ŒDirect I/O åœºæ™¯ä¸­ï¼Œå†…æ ¸éœ€è¦ map/unmap memory areasã€‚io_uring æ”¯æŒæå‰æ³¨å†Œè¿™äº›ç¼“å†²åŒºï¼ˆbuffersï¼‰ã€‚</li><li>Poll ring(è½®è¯¢ç¯å½¢ç¼“å†²åŒº)ï¼šå¯¹äºéå¸¸å¿«æ˜¯è®¾å¤‡ï¼Œå¤„ç†ä¸­æ–­çš„å¼€é”€æ˜¯æ¯”è¾ƒå¤§çš„ã€‚io_uring å…è®¸ç”¨æˆ·å…³é—­ä¸­æ–­ï¼Œä½¿ç”¨è½®è¯¢æ¨¡å¼ã€‚</li><li>Linked operations(é“¾æ¥æ“ä½œ)ï¼šå…è®¸ç”¨æˆ·å‘é€ä¸²è”çš„è¯·æ±‚ã€‚è¿™ä¸¤ä¸ªè¯·æ±‚åŒæ—¶æäº¤ï¼Œä½†åé¢çš„ä¼šç­‰å‰é¢çš„å¤„ç†å®Œæ‰å¼€å§‹æ‰§è¡Œã€‚</li></ul></li></ul><h2 id=ä¸‰io_uring-çš„ä½¿ç”¨ç¤ºä¾‹>ä¸‰ã€io_uring çš„ä½¿ç”¨ç¤ºä¾‹</h2><p>liburing æä¾›äº†ä¸€ä¸ªç®€å•çš„é«˜å±‚ APIï¼Œ å¯ç”¨äºä¸€äº›åŸºæœ¬åœºæ™¯ï¼Œåº”ç”¨ç¨‹åºé¿å…äº†ç›´æ¥ä½¿ç”¨æ›´åº•å±‚çš„ç³»ç»Ÿè°ƒç”¨ã€‚æ­¤å¤–ï¼Œè¿™ä¸ª API è¿˜é¿å…äº†ä¸€äº›é‡å¤æ“ä½œçš„ä»£ç ï¼Œå¦‚è®¾ç½® io_uring å®ä¾‹ã€‚</p><h3 id=1-åœ¨é¡¹ç›®ä¸­å¼•å…¥-liburing>1. åœ¨é¡¹ç›®ä¸­å¼•å…¥ liburing</h3><ol><li>apt-get å®‰è£… liburing<ul><li>åœ¨ ubuntu ç³»ç»Ÿä¸‹å®‰è£… liburing ååˆ†ç®€å•ï¼Œåªéœ€è¦æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å³å¯ ï¼ˆæ³¨æ„ï¼šubuntu ç‰ˆæœ¬éœ€è¦å¤§äºç­‰äº 20.04ï¼Œå› ä¸ºå†…æ ¸ç‰ˆæœ¬éœ€è¦å¤§äºç­‰äº 5.4ï¼‰<pre><code class=language-shell>sudo apt-get install liburing-dev
</code></pre></li><li>åœ¨é¡¹ç›®ä¸­å¼•å…¥ liburing çš„å¤´æ–‡ä»¶<pre><code class=language-c>#include &quot;liburing.h&quot;
</code></pre></li><li>åœ¨é¡¹ç›®ä¸­å¼•å…¥ liburing çš„åº“æ–‡ä»¶<pre><code class=language-c>-luring
</code></pre></li></ul></li><li>æ‰‹åŠ¨å®‰è£…<ul><li>ä¸‹è½½ liburing çš„æºç <pre><code class=language-shell>git clone https://github.com/axboe/liburing.git
</code></pre></li><li>ç¼–è¯‘ liburing<pre><code class=language-shell>cd liburing
./configure
make -j
sudo make install
</code></pre></li><li>åœ¨é¡¹ç›®ä¸­å¼•å…¥ liburing çš„å¤´æ–‡ä»¶<pre><code class=language-c>#include &quot;liburing.h&quot;
</code></pre></li><li>åœ¨é¡¹ç›®ä¸­å¼•å…¥ liburing çš„åº“æ–‡ä»¶<pre><code class=language-c>-luring
</code></pre></li></ul></li></ol><h3 id=2-ä»£ç ç¤ºä¾‹>2. ä»£ç ç¤ºä¾‹</h3><ul><li>ä½¿ç”¨ 4 ä¸ª SQEï¼Œä»è¾“å…¥æ–‡ä»¶ä¸­è¯»å–æœ€å¤š 16KB çš„æ•°æ®ã€‚</li></ul><pre><code class=language-c>#include &quot;liburing.h&quot;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;unistd.h&gt;
#include &lt;errno.h&gt;

// io_uring é˜Ÿåˆ—é•¿åº¦
#define QUEUE_DEPTH 4

int main(int argc, char** argv)
{
  int fd, pending, done;
  void* buf;

  // 1. åˆå§‹åŒ–ä¸€ä¸ª io_uring å®ä¾‹
  struct io_uring ring;
  // åˆ›å»ºä¸€ä¸ª io_uring å®ä¾‹ï¼Œé˜Ÿåˆ—é•¿åº¦ä¸º QUEUE_DEPTHï¼Œflags ä¸º 0ï¼Œä½¿ç”¨é»˜è®¤æ¨¡å¼
  int ret = io_uring_queue_init(QUEUE_DEPTH, &amp;ring, 0);
  if (ret)
  {
    fprintf(stderr, &quot;io_uring_queue_init: %s\n&quot;, strerror(-ret));
    return 1;
  }
  // 2. æ‰“å¼€è¾“å…¥æ–‡ä»¶ï¼ŒæŒ‡å®š O_DIRECT æ ‡å¿—
  fd = open(argv[1], O_RDONLY | O_DIRECT);
  struct stat st;
  fstat(fd, &amp;st);

  // 3. åˆå§‹åŒ– 4 ä¸ªè¯»ç¼“å†²åŒº
  size_t filesize = 0;
  struct iovec *iovecs = calloc(QUEUE_DEPTH, sizeof(struct iovec));
  for (int i = 0; i &lt; QUEUE_DEPTH; i++)
  {
      if (posix_memalign(&amp;buf, 4096, 4096))
      {
          perror(&quot;posix_memalign&quot;);
          return 1;
      }
      iovecs[i].iov_base = buf;
      iovecs[i].iov_len = 4096;
      filesize += 4096;
  }
  // 4. ä¾æ¬¡å‡†å¤‡ 4 ä¸ªè¯»è¯·æ±‚ï¼ŒæŒ‡å®šå°†éšåè¯»å…¥çš„æ•°æ®å†™å…¥ iovecs ä¸­
  struct io_uring_sqe *sqe;
  size_t offset = 0;
  int i = 0;
  do
  {
    sqe = io_uring_get_sqe(&amp;ring);
    io_uring_prep_readv(sqe, fd, &amp;iovecs[i], 1, offset);
    offset += iovecs[i].iov_len;
    i++;
    // å¦‚æœè¶…å‡ºæ–‡ä»¶å¤§å°ï¼Œåœæ­¢å‡†å¤‡åé¢çš„ SQE
    if (offset &gt;= st.st_size)
    {
        break;
    }
  } while (1);

  // 5. æäº¤ SQE è¯»è¯·æ±‚
  ret = io_uring_submit(&amp;ring);
  if (ret &lt; 0)
  {
      fprintf(stderr, &quot;io_uring_submit: %s\n&quot;, strerror(-ret));
      return 1;
  } else if (ret != i) {
      fprintf(stderr, &quot;io_uring_submit submitted less %d\n&quot;, ret);
      return 1;
  }

  // 6. ç­‰å¾…è¯»è¯·æ±‚å®Œæˆ
  struct io_uring_cqe *cqe;
  done = 0;
  pending = ret;
  filesize = 0;
  for (int i = 0; i &lt; pending; i++) {
      // ç­‰å¾…ä¸€ä¸ªè¯»å®Œæˆäº‹ä»¶
      io_uring_wait_cqe(&amp;ring, &amp;cqe);
      done++;
      if (cqe-&gt;res != 4096 &amp;&amp; cqe-&gt;res + filesize != st.st_size) {
            fprintf(stderr, &quot;cqe-&gt;res: %d\n&quot;, cqe-&gt;res);
            return 1;
      }
      filesize += cqe-&gt;res;
      // æ›´æ–°å®Œæˆé˜Ÿåˆ—
      io_uring_cqe_seen(&amp;ring, cqe);
  }

  // 7. æ‰“å°ç»Ÿè®¡ä¿¡æ¯
  printf(&quot;Submitted = %d, completed = %d, bytes = %lu\n&quot;, pending, done, (unsigned long)filesize);

  // 8. é”€æ¯èµ„æº
  close(fd);
  io_uring_queue_exit(&amp;ring);
  return 0;
}
</code></pre><ul><li>link-cpï¼šä½¿ç”¨ io_uring é«˜çº§ç‰¹æ€§ SQE chaining å®ç°å¤åˆ¶æ–‡ä»¶åŠŸèƒ½ï¼Œå°†åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º 2 çš„ SQE é“¾ï¼Œç¬¬ä¸€ä¸ª SQE ç”¨äºè¯»ï¼Œç¬¬äºŒä¸ª SQE ç”¨äºå†™ã€‚</li></ul><pre><code class=language-c>#include &lt;assert.h&gt;
#include &lt;errno.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;inttypes.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/ioctl.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;unistd.h&gt;
#include &quot;liburing.h&quot;

#define QD 64
#define BS (32 * 1024)

struct io_data
{
    size_t offset;
    int index;
    struct iovec iov;
};

static int infd, outfd;
static int inflight;

static int setup_context(unsigned entries, struct io_uring *ring)
{
    int ret;

    ret = io_uring_queue_init(entries, ring, 0);
    if (ret &lt; 0)
    {
        fprintf(stderr, &quot;queue_init: %s\n&quot;, strerror(-ret));
        return -1;
    }

    return 0;
}

static int get_file_size(int fd, off_t *size)
{
    struct stat st;

    if (fstat(fd, &amp;st) &lt; 0)
        return -1;
    if (S_ISREG(st.st_mode))
    {
        *size = st.st_size;
        return 0;
    }
    else if (S_ISBLK(st.st_mode))
    {
        unsigned long long bytes;

        if (ioctl(fd, BLKGETSIZE64, &amp;bytes) != 0)
            return -1;

        *size = bytes;
        return 0;
    }

    return -1;
}

static void queue_rw_pair(struct io_uring *ring, off_t size, off_t offset)
{
    struct io_uring_sqe *sqe;
    struct io_data *data;
    void *ptr;

    ptr                = malloc(size + sizeof(*data));
    data               = ptr + size;
    data-&gt;index        = 0;
    data-&gt;offset       = offset;
    data-&gt;iov.iov_base = ptr;
    data-&gt;iov.iov_len  = size;

    sqe = io_uring_get_sqe(ring);
    io_uring_prep_readv(sqe, infd, &amp;data-&gt;iov, 1, offset);
    sqe-&gt;flags |= IOSQE_IO_LINK;
    io_uring_sqe_set_data(sqe, data);

    sqe = io_uring_get_sqe(ring);
    io_uring_prep_writev(sqe, outfd, &amp;data-&gt;iov, 1, offset);
    io_uring_sqe_set_data(sqe, data);
}

static int handle_cqe(struct io_uring *ring, struct io_uring_cqe *cqe)
{
    struct io_data *data = io_uring_cqe_get_data(cqe);
    int ret              = 0;

    data-&gt;index++;

    if (cqe-&gt;res &lt; 0)
    {
        if (cqe-&gt;res == -ECANCELED)
        {
            queue_rw_pair(ring, data-&gt;iov.iov_len, data-&gt;offset);
            inflight += 2;
        }
        else
        {
            printf(&quot;cqe error: %s\n&quot;, strerror(-cqe-&gt;res));
            ret = 1;
        }
    }

    if (data-&gt;index == 2)
    {
        void *ptr = (void *)data - data-&gt;iov.iov_len;

        free(ptr);
    }
    io_uring_cqe_seen(ring, cqe);
    return ret;
}

static int copy_file(struct io_uring *ring, off_t insize)
{
    struct io_uring_cqe *cqe;
    off_t this_size;
    off_t offset;

    offset = 0;
    while (insize)
    {
        int has_inflight = inflight;
        int depth;

        while (insize &amp;&amp; inflight &lt; QD)
        {
            this_size = BS;
            if (this_size &gt; insize)
                this_size = insize;
            queue_rw_pair(ring, this_size, offset);
            offset += this_size;
            insize -= this_size;
            inflight += 2;
        }

        if (has_inflight != inflight)
            io_uring_submit(ring);

        if (insize)
            depth = QD;
        else
            depth = 1;
        while (inflight &gt;= depth)
        {
            int ret;

            ret = io_uring_wait_cqe(ring, &amp;cqe);
            if (ret &lt; 0)
            {
                printf(&quot;wait cqe: %s\n&quot;, strerror(-ret));
                return 1;
            }
            if (handle_cqe(ring, cqe))
                return 1;
            inflight--;
        }
    }

    return 0;
}

int main(int argc, char *argv[])
{
    struct io_uring ring;
    off_t insize;
    int ret;

    if (argc &lt; 3)
    {
        printf(&quot;%s: infile outfile\n&quot;, argv[0]);
        return 1;
    }

    infd = open(argv[1], O_RDONLY);
    if (infd &lt; 0)
    {
        perror(&quot;open infile&quot;);
        return 1;
    }
    outfd = open(argv[2], O_WRONLY | O_CREAT | O_TRUNC, 0644);
    if (outfd &lt; 0)
    {
        perror(&quot;open outfile&quot;);
        return 1;
    }

    if (setup_context(QD, &amp;ring))
        return 1;
    if (get_file_size(infd, &amp;insize))
        return 1;

    ret = copy_file(&amp;ring, insize);

    close(infd);
    close(outfd);
    io_uring_queue_exit(&amp;ring);
    return ret;
}

</code></pre><ul><li>copy_file()ï¼šé«˜å±‚å¤åˆ¶å¾ªç¯é€»è¾‘ï¼›å®ƒä¼šè°ƒç”¨ queue_rw_pair(ring, this_size, offset) æ¥æ„é€  SQE pairï¼›å¹¶é€šè¿‡ä¸€æ¬¡ io_uring_submit() è°ƒç”¨å°†æ‰€æœ‰æ„å»ºçš„ SQE pair æäº¤ã€‚ è¿™ä¸ªå‡½æ•°ç»´æŠ¤äº†ä¸€ä¸ªæœ€å¤§ DQ æ•°é‡çš„ inflight SQEï¼Œåªè¦æ•°æ® copy è¿˜åœ¨è¿›è¡Œä¸­ï¼›å¦åˆ™ï¼Œå³æ•°æ®å·²ç»å…¨éƒ¨è¯»å–å®Œæˆï¼Œå°±å¼€å§‹ç­‰å¾…å’Œæ”¶å‰²æ‰€æœ‰çš„ CQEã€‚</li><li>queue_rw_pair() æ„é€ ä¸€ä¸ª read-write SQE pair. read SQE çš„ IOSQE_IO_LINK flag è¡¨ç¤ºå¼€å§‹ä¸€ä¸ª chainï¼Œwrite SQE ä¸ç”¨è®¾ç½®è¿™ä¸ª flagï¼Œæ ‡å¿—ç€è¿™ä¸ª chain çš„ç»“æŸã€‚ç”¨æˆ· data å­—æ®µè®¾ç½®ä¸ºåŒä¸€ä¸ª data æè¿°ç¬¦ï¼Œå¹¶ä¸”åœ¨éšåçš„ completion å¤„ç†ä¸­ä¼šç”¨åˆ°ã€‚</li><li>handle_cqe() ä» CQE ä¸­æå–ä¹‹å‰ç”± Â queue_rw_pair() ä¿å­˜çš„ data æè¿°ç¬¦ï¼Œå¹¶åœ¨æè¿°ç¬¦ä¸­è®°å½•å¤„ç†è¿›å±•ï¼ˆindexï¼‰ã€‚ å¦‚æœä¹‹å‰è¯·æ±‚è¢«å–æ¶ˆï¼Œå®ƒè¿˜ä¼šé‡æ–°æäº¤ read-write pairã€‚ ä¸€ä¸ª CQE pair çš„ä¸¤ä¸ª member éƒ½å¤„ç†å®Œæˆä¹‹åï¼ˆindex==2ï¼‰ï¼Œé‡Šæ”¾å…±äº«çš„ data descriptorã€‚æœ€åé€šçŸ¥å†…æ ¸è¿™ä¸ª CQE å·²ç»è¢«æ¶ˆè´¹ã€‚</li></ul><h3 id=3-æœ€ä½³å®è·µ>3. æœ€ä½³å®è·µ</h3><p>io_uring æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„å¼‚æ­¥ I/O æ¡†æ¶ï¼Œå®ƒåœ¨ Linux å†…æ ¸ä¸­å¼•å…¥äº†ä¸€ç§æ–°çš„ I/O æ¨¡å‹ï¼Œå¯ä»¥æ˜¾è‘—æé«˜ I/O æ“ä½œçš„ååé‡å’Œå“åº”é€Ÿåº¦ã€‚ç„¶è€Œï¼Œè¦å……åˆ†å‘æŒ¥ io_uring çš„ä¼˜åŠ¿ï¼Œéœ€è¦æ³¨æ„ä¸€äº›ä¼˜åŒ–å’Œæœ€ä½³å®è·µã€‚</p><div class=table-wrapper><table><thead><tr><th>ä¼˜åŒ–</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>æ‰¹é‡æäº¤ï¼ˆBatch Submissionï¼‰</td><td>io_uring æ”¯æŒæ‰¹é‡æäº¤å¤šä¸ª I/O è¯·æ±‚ï¼Œä»¥å‡å°‘ç³»ç»Ÿè°ƒç”¨çš„å¼€é”€ã€‚é€šè¿‡ä¸€æ¬¡æ€§æäº¤å¤šä¸ªè¯·æ±‚ï¼Œå¯ä»¥å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œç³»ç»Ÿè°ƒç”¨çš„æ¬¡æ•°ï¼Œæé«˜æ•ˆç‡ã€‚å»ºè®®æ ¹æ®ç³»ç»Ÿçš„è´Ÿè½½å’Œæ€§èƒ½éœ€æ±‚ï¼Œåˆç†é€‰æ‹©æ‰¹é‡æäº¤çš„æ•°é‡ã€‚</td></tr><tr><td>é¢„åˆ†é… I/O è¯·æ±‚ï¼ˆPre-allocate I/O Requestsï¼‰</td><td>åœ¨ä½¿ç”¨ io_uring ä¹‹å‰ï¼Œå¯ä»¥é¢„å…ˆåˆ†é…ä¸€å®šæ•°é‡çš„ I/O è¯·æ±‚ï¼Œé¿å…åœ¨è¿è¡Œæ—¶åŠ¨æ€åˆ†é…è¯·æ±‚çš„å¼€é”€ã€‚è¿™æ ·å¯ä»¥å‡å°‘å†…å­˜åˆ†é…å’Œé‡Šæ”¾çš„æ¬¡æ•°ï¼Œæé«˜æ€§èƒ½ã€‚</td></tr><tr><td>ä½¿ç”¨ I/O é“¾æ¥ï¼ˆI/O Linkingï¼‰</td><td>io_uring æ”¯æŒå°†å¤šä¸ª I/O è¯·æ±‚é“¾æ¥åœ¨ä¸€èµ·ï¼Œå½¢æˆä¸€ä¸ªé“¾è¡¨ã€‚è¿™æ ·å¯ä»¥å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ï¼Œæé«˜æ•ˆç‡ã€‚åœ¨é“¾æ¥ I/O è¯·æ±‚æ—¶ï¼Œéœ€è¦æ³¨æ„ä¿æŒè¯·æ±‚çš„é¡ºåºå’Œæ­£ç¡®å¤„ç†é“¾æ¥çš„å®Œæˆã€‚</td></tr><tr><td>ä½¿ç”¨ I/O å‘é‡ï¼ˆI/O Vectorï¼‰</td><td>io_uring æ”¯æŒä½¿ç”¨ I/O å‘é‡æ¥è¿›è¡Œæ‰¹é‡çš„è¯»å†™æ“ä½œã€‚é€šè¿‡ä½¿ç”¨ I/O å‘é‡ï¼Œå¯ä»¥å‡å°‘ç³»ç»Ÿè°ƒç”¨çš„æ¬¡æ•°ï¼Œæé«˜æ•ˆç‡ã€‚åœ¨ä½¿ç”¨ I/O å‘é‡æ—¶ï¼Œéœ€è¦æ³¨æ„æ­£ç¡®è®¾ç½®æ¯ä¸ªå‘é‡çš„åç§»é‡å’Œé•¿åº¦ã€‚</td></tr><tr><td>ä½¿ç”¨äº‹ä»¶å®Œæˆé€šçŸ¥ï¼ˆEvent Completion Notificationï¼‰</td><td>io_uring æ”¯æŒä½¿ç”¨äº‹ä»¶å®Œæˆé€šçŸ¥æ¥æé«˜æ•ˆç‡ã€‚é€šè¿‡ä½¿ç”¨äº‹ä»¶å®Œæˆé€šçŸ¥ï¼Œå¯ä»¥é¿å…è½®è¯¢ç­‰å¾… I/O å®Œæˆï¼Œè€Œæ˜¯åœ¨ I/O å®Œæˆæ—¶ç«‹å³å¾—åˆ°é€šçŸ¥ã€‚è¿™æ ·å¯ä»¥å‡å°‘ CPU çš„å ç”¨å’Œå“åº”æ—¶é—´ã€‚</td></tr><tr><td>åˆç†è®¾ç½® I/O é˜Ÿåˆ—æ·±åº¦ï¼ˆI/O Queue Depthï¼‰</td><td>io_uring çš„æ€§èƒ½å—åˆ° I/O é˜Ÿåˆ—æ·±åº¦çš„å½±å“ã€‚è¾ƒå¤§çš„é˜Ÿåˆ—æ·±åº¦å¯ä»¥æé«˜å¹¶å‘æ€§èƒ½ï¼Œä½†ä¹Ÿä¼šå¢åŠ å†…å­˜å¼€é”€ã€‚å»ºè®®æ ¹æ®ç³»ç»Ÿçš„è´Ÿè½½å’Œæ€§èƒ½éœ€æ±‚ï¼Œåˆç†è®¾ç½® I/O é˜Ÿåˆ—æ·±åº¦ã€‚</td></tr><tr><td>ä½¿ç”¨åˆé€‚çš„å†…å­˜åˆ†é…ç­–ç•¥</td><td>io_uring çš„æ€§èƒ½ä¹Ÿå—åˆ°å†…å­˜åˆ†é…ç­–ç•¥çš„å½±å“ã€‚å»ºè®®ä½¿ç”¨é«˜æ•ˆçš„å†…å­˜åˆ†é…å™¨ï¼Œå¦‚ jemalloc æˆ– tcmallocï¼Œæ¥å‡å°‘å†…å­˜åˆ†é…å’Œé‡Šæ”¾çš„å¼€é”€ã€‚</td></tr><tr><td>é¿å…é˜»å¡æ“ä½œ</td><td>io_uring æ˜¯ä¸€ä¸ªå¼‚æ­¥ I/O æ¡†æ¶ï¼Œåº”å°½é‡é¿å…åœ¨ io_uring çš„ä¸Šä¸‹æ–‡ä¸­è¿›è¡Œé˜»å¡æ“ä½œã€‚é˜»å¡æ“ä½œä¼šå¯¼è‡´ io_uring çš„æ€§èƒ½ä¸‹é™ï¼Œç”šè‡³å¯èƒ½å¼•èµ·æ­»é”ã€‚</td></tr><tr><td>ä½¿ç”¨åˆé€‚çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆFile Descriptorï¼‰</td><td>io_uring æ”¯æŒå¯¹æ–‡ä»¶ã€å¥—æ¥å­—å’Œç®¡é“ç­‰ä¸åŒç±»å‹çš„æ–‡ä»¶æè¿°ç¬¦è¿›è¡Œæ“ä½œã€‚åœ¨ä½¿ç”¨ io_uring æ—¶ï¼Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µé€‰æ‹©åˆé€‚çš„æ–‡ä»¶æè¿°ç¬¦ç±»å‹ï¼Œå¹¶æ­£ç¡®è®¾ç½®ç›¸å…³çš„å‚æ•°ã€‚</td></tr><tr><td>æ³¨æ„é”™è¯¯å¤„ç†</td><td>åœ¨ä½¿ç”¨ io_uring æ—¶ï¼Œéœ€è¦æ³¨æ„æ­£ç¡®å¤„ç†é”™è¯¯ã€‚io_uring çš„é”™è¯¯ç å¯èƒ½æ˜¯è´Ÿæ•°ï¼Œå¯ä»¥ä½¿ç”¨ errno.h ä¸­å®šä¹‰çš„é”™è¯¯ç æ¥è¿›è¡Œè§£æå’Œå¤„ç†ã€‚</td></tr></tbody></table></div><p>é€šè¿‡éµå¾ªä¸Šè¿°ä¼˜åŒ–å’Œæœ€ä½³å®è·µï¼Œå¯ä»¥å……åˆ†å‘æŒ¥ io_uring çš„æ€§èƒ½ä¼˜åŠ¿ï¼Œæé«˜ç³»ç»Ÿçš„ I/O æ€§èƒ½å’Œå“åº”é€Ÿåº¦ã€‚ç„¶è€Œï¼Œéœ€è¦æ ¹æ®å…·ä½“çš„åº”ç”¨åœºæ™¯å’Œéœ€æ±‚ï¼Œè¿›è¡Œåˆç†çš„è°ƒä¼˜å’Œé…ç½®ã€‚åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œå¯ä»¥é€šè¿‡æ€§èƒ½æµ‹è¯•å’Œç›‘æµ‹æ¥è¯„ä¼°å’Œä¼˜åŒ– io_uring çš„æ€§èƒ½ã€‚</p><h2 id=ç»“è®º>ç»“è®º</h2><ul><li><p>io_uring æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„å¼‚æ­¥ I/O æ¡†æ¶ï¼Œé€šè¿‡åœ¨ Linux å†…æ ¸ä¸­å¼•å…¥æ–°çš„ I/O æ¨¡å‹ï¼Œå®ƒèƒ½å¤Ÿæ˜¾è‘—æé«˜ I/O æ“ä½œçš„ååé‡å’Œå“åº”é€Ÿåº¦ã€‚æœ¬ç« èŠ‚æˆ‘ä»¬æ·±å…¥æ¢è®¨äº† io_uring çš„ä¼˜åŒ–å’Œæœ€ä½³å®è·µï¼Œä»¥å¸®åŠ©å¼€å‘è€…å……åˆ†å‘æŒ¥å…¶æ€§èƒ½ä¼˜åŠ¿ã€‚</p></li><li><p>åœ¨ä½¿ç”¨ io_uring æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡å–ä¸€ç³»åˆ—ä¼˜åŒ–æªæ–½æ¥æé«˜æ€§èƒ½ã€‚é¦–å…ˆï¼Œæ‰¹é‡æäº¤å¤šä¸ª I/O è¯·æ±‚å¯ä»¥å‡å°‘ç³»ç»Ÿè°ƒç”¨çš„å¼€é”€ï¼Œæé«˜æ•ˆç‡ã€‚æ­¤å¤–ï¼Œé¢„åˆ†é… I/O è¯·æ±‚ã€ä½¿ç”¨ I/O é“¾æ¥å’Œ I/O å‘é‡ç­‰æŠ€æœ¯ä¹Ÿèƒ½å¤Ÿå‡å°‘å†…å­˜åˆ†é…å’Œç³»ç»Ÿè°ƒç”¨çš„æ¬¡æ•°ï¼Œè¿›ä¸€æ­¥æå‡æ€§èƒ½ã€‚</p></li><li><p>é™¤äº†ä»¥ä¸Šçš„ä¼˜åŒ–æŠ€å·§ï¼Œæˆ‘ä»¬è¿˜ä»‹ç»äº†ä¸€äº›æœ€ä½³å®è·µã€‚åˆç†è®¾ç½® I/O é˜Ÿåˆ—æ·±åº¦ã€ä½¿ç”¨äº‹ä»¶å®Œæˆé€šçŸ¥å’Œé€‰æ‹©åˆé€‚çš„æ–‡ä»¶æè¿°ç¬¦ç±»å‹ç­‰éƒ½èƒ½å¤Ÿå¯¹æ€§èƒ½äº§ç”Ÿç§¯æå½±å“ã€‚æ­¤å¤–ï¼Œé¿å…é˜»å¡æ“ä½œå’Œæ­£ç¡®å¤„ç†é”™è¯¯ä¹Ÿæ˜¯ä½¿ç”¨ io_uring æ—¶éœ€è¦æ³¨æ„çš„äº‹é¡¹ã€‚</p></li><li><p>é€šè¿‡éµå¾ªè¿™äº›ä¼˜åŒ–å’Œæœ€ä½³å®è·µï¼Œå¼€å‘è€…å¯ä»¥å……åˆ†å‘æŒ¥ io_uring çš„æ€§èƒ½ä¼˜åŠ¿ï¼Œæé«˜ç³»ç»Ÿçš„ I/O æ€§èƒ½å’Œå“åº”é€Ÿåº¦ã€‚ç„¶è€Œï¼Œéœ€è¦æ ¹æ®å…·ä½“çš„åº”ç”¨åœºæ™¯å’Œéœ€æ±‚ï¼Œè¿›è¡Œåˆç†çš„è°ƒä¼˜å’Œé…ç½®ã€‚åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œå¯ä»¥é€šè¿‡æ€§èƒ½æµ‹è¯•å’Œç›‘æµ‹æ¥è¯„ä¼°å’Œä¼˜åŒ– io_uring çš„æ€§èƒ½ã€‚</p></li><li><p>io_uring ä½œä¸ºä¸€ä¸ªæ–°å…´çš„å¼‚æ­¥ I/O æ¡†æ¶ï¼Œå…·æœ‰å¾ˆå¤§çš„æ½œåŠ›å’Œå¹¿é˜”çš„åº”ç”¨å‰æ™¯ã€‚å®ƒå·²ç»åœ¨è®¸å¤šé¢†åŸŸå¾—åˆ°äº†å¹¿æ³›çš„åº”ç”¨ï¼Œå¦‚æ•°æ®åº“ã€ç½‘ç»œæœåŠ¡å™¨å’Œå­˜å‚¨ç³»ç»Ÿç­‰ã€‚éšç€å¯¹ io_uring çš„è¿›ä¸€æ­¥ç ”ç©¶å’Œä¼˜åŒ–ï¼Œç›¸ä¿¡å®ƒå°†åœ¨æœªæ¥å‘æŒ¥æ›´å¤§çš„ä½œç”¨ï¼Œå¹¶æˆä¸ºå¼€å‘è€…ä»¬çš„é¦–é€‰å·¥å…·ä¹‹ä¸€ã€‚</p></li></ul><h2 id=å‚è€ƒæ–‡çŒ®>å‚è€ƒæ–‡çŒ®</h2><p>[1] io_uring å®˜æ–¹æ–‡æ¡£ï¼š<a class=link href=https://kernel.dk/io_uring.pdf target=_blank rel=noopener>https://kernel.dk/io_uring.pdf
<span style=white-space:nowrap><svg width=".8em" height=".8em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a></p><p>[2] How io_uring and eBPF Will Revolutionize Programming in Linux[1], ScyllaDB</p><p>[3] 2020 An Introduction to the io_uring Asynchronous I/O Framework[2], Oracle, 2020</p><p>[4] liburing GitHub ä»“åº“ï¼š<a class=link href=https://github.com/axboe/liburing target=_blank rel=noopener>https://github.com/axboe/liburing
<span style=white-space:nowrap><svg width=".8em" height=".8em" viewBox="0 0 21 21" xmlns="http://www.w3.org/2000/svg"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a></p></section><footer class=article-footer><section class=article-tags><a href=/tags/aio/>AIO</a>
<a href=/tags/linux-kernel/>Linux å†…æ ¸</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer><script type=text/javascript src=/js/prism.js async></script></article><aside class=related-content--wrapper><h2 class=section-title>ç›¸å…³æ–‡ç« </h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/thead-tools/><div class=article-image><img src=https://cuterwrite-1302252842.file.myqcloud.com/img/59aa9fecb7e1a3a2b2c88811e6360647195413.jpg@1256w_774h_!web-article-pic-2024-02-20.webp loading=lazy data-key=thead-tools data-hash=https://cuterwrite-1302252842.file.myqcloud.com/img/59aa9fecb7e1a3a2b2c88811e6360647195413.jpg@1256w_774h_!web-article-pic-2024-02-20.webp></div><div class=article-details><h2 class=article-title>æ­å»ºç„é“ 900 ç³»åˆ—å·¥å…·é“¾ä¸ xuantie-qemu ç¯å¢ƒ</h2></div></a></article><article class=has-image><a href=/p/false-sharing/><div class=article-image><img src=https://cuterwrite-1302252842.file.myqcloud.com/blog/6c3f8961290e41f894f5a1cbb768aba9-2023-12-02.webp loading=lazy data-key=false-sharing data-hash=https://cuterwrite-1302252842.file.myqcloud.com/blog/6c3f8961290e41f894f5a1cbb768aba9-2023-12-02.webp></div><div class=article-details><h2 class=article-title>æ€§èƒ½åˆºå®¢ä¹‹ä¼ªå…±äº«</h2></div></a></article><article class=has-image><a href=/p/openmp-intro/><div class=article-image><img src=https://cuterwrite-1302252842.file.myqcloud.com/img/c17b7451a44c1d4370d5ba2b966298ea195413_crop-2024-02-19.webp loading=lazy data-key=openmp-intro data-hash=https://cuterwrite-1302252842.file.myqcloud.com/img/c17b7451a44c1d4370d5ba2b966298ea195413_crop-2024-02-19.webp></div><div class=article-details><h2 class=article-title>OpenMP ç®€ä»‹</h2></div></a></article><article class=has-image><a href=/p/rdma-element/><div class=article-image><img src=https://cuterwrite-1302252842.file.myqcloud.com/img/73c30b990886bf6988c97858a3e16011195413_crop-2024-02-04.webp loading=lazy data-key=rdma-element data-hash=https://cuterwrite-1302252842.file.myqcloud.com/img/73c30b990886bf6988c97858a3e16011195413_crop-2024-02-04.webp></div><div class=article-details><h2 class=article-title>RDMA åŸºæœ¬å…ƒç´ </h2></div></a></article><article class=has-image><a href=/p/ethernet-vs-rdma/><div class=article-image><img src=https://cuterwrite-1302252842.file.myqcloud.com/img/cropped_2024010202-2024-02-03.webp loading=lazy data-key=ethernet-vs-rdma data-hash=https://cuterwrite-1302252842.file.myqcloud.com/img/cropped_2024010202-2024-02-03.webp></div><div class=article-details><h2 class=article-title>æ¯”è¾ƒåŸºäºä¼ ç»Ÿä»¥å¤ªç½‘ä¸ RDMA æŠ€æœ¯çš„é€šä¿¡</h2></div></a></article></div></div></aside><script>(function(){if(/^localhost|^127/.test(location.hostname))return;let e=document.createElement("script");e.src="https://giscus.app/client.js",e.dataset.repo="PKUcoldkeyboard/pkucoldkeyboard.github.io",e.dataset.repoId="MDEwOlJlcG9zaXRvcnkzMzU4NzI5OTI=",e.dataset.category="Comments",e.dataset.categoryId="DIC_kwDOFAUD4M4CZV4F",e.dataset.mapping="title",e.dataset.strict="0",e.dataset.reactionsEnabled="1",e.dataset.emitMetadata="0",e.dataset.inputPosition="top",e.dataset.theme="light",e.dataset.lang="zh-CN",e.dataset.loading="lazy",e.crossOrigin="anonymous",e.async=!0;let t=document.querySelector(".main"),n=t.childNodes[t.childNodes.length-1];t.insertBefore(e,n.nextSibling)})();function setGiscusTheme(e){let t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}(function(){if(/^localhost|^127/.test(location.hostname))return;addEventListener("message",t=>{if(event.origin!=="https://giscus.app")return;e()}),window.addEventListener("onColorSchemeChange",e);function e(){setGiscusTheme(document.documentElement.dataset.scheme==="light"?"light":"dark_dimmed")}})()</script><footer class=site-footer><section class=copyright>&copy;
2021 -
2024 cuterwrite</section><section class=running-time>æœ¬åšå®¢å·²ç¨³å®šè¿è¡Œ
<span id=runningdays class=running-days></span></section><section class=totalcount>å‘è¡¨äº†55ç¯‡æ–‡ç«  Â·
æ€»è®¡239.78kå­—</section><section class=powerby>Welcome to cuterwrite's blog!<br>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>ä¸»é¢˜ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.17.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è®¾è®¡</section></footer><script>let s1="2021-4-17";s1=new Date(s1.replace(/-/g,"/"));let s2=new Date,timeDifference=s2.getTime()-s1.getTime(),days=Math.floor(timeDifference/(1e3*60*60*24)),hours=Math.floor(timeDifference%(1e3*60*60*24)/(1e3*60*60)),minutes=Math.floor(timeDifference%(1e3*60*60)/(1e3*60)),result=days+"å¤©"+hours+"å°æ—¶"+minutes+"åˆ†é’Ÿ";document.getElementById("runningdays").innerHTML=result</script><script>(function(){var t,e=window;if(e.ChannelIO)return e.console.error("ChannelIO script included twice.");t=function(){t.c(arguments)},t.q=[],t.c=function(e){t.q.push(e)},e.ChannelIO=t;function n(){if(e.ChannelIOInitialized)return;e.ChannelIOInitialized=!0;var n,t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src="https://cdn.channel.io/plugin/ch-plugin-web.js",n=document.getElementsByTagName("script")[0],n.parentNode&&n.parentNode.insertBefore(t,n)}document.readyState==="complete"?n():(e.addEventListener("DOMContentLoaded",n),e.addEventListener("load",n))})(),ChannelIO("boot",{pluginKey:"3182ceac-0382-4734-98f5-1e6fec11c935"})</script><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.bootcdn.net/ajax/libs/photoswipe/4.1.3/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.bootcdn.net/ajax/libs/photoswipe/4.1.3/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.bootcdn.net/ajax/libs/photoswipe/4.1.3/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.bootcdn.net/ajax/libs/photoswipe/4.1.3/photoswipe.min.css crossorigin=anonymous></main></div><script type=text/javascript src=/ts/main.js defer></script><script async src=https://umami-gamma-virid.vercel.app/uma data-website-id=635c2011-51a9-4ffc-b360-f5572bb94276></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.font.im/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>