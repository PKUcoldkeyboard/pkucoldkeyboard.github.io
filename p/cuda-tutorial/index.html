<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="本文深入解析了 CUDA 编程，从介绍 CUDA 的基本概念开始，探讨 CPU 与 GPU 的差异，详述异构计算的理念。进一步，我们将深入 CUDA 编程模型，讲解 CUDA 线程执行模型，以及如何在 CUDA 中使用原子操作。将帮助读者更好地理解和利用 GPU 的强大计算能力。"><title>CUDA 编程：从基础到应用</title>
<link rel=canonical href=https://cuterwrite.top/p/cuda-tutorial/><link rel=stylesheet href=/scss/style.min.16eabdfedb338a01145151843dead3f12e94f59ef7c070367366d15405d0f4b6.css><meta property='og:title' content="CUDA 编程：从基础到应用"><meta property='og:description' content="本文深入解析了 CUDA 编程，从介绍 CUDA 的基本概念开始，探讨 CPU 与 GPU 的差异，详述异构计算的理念。进一步，我们将深入 CUDA 编程模型，讲解 CUDA 线程执行模型，以及如何在 CUDA 中使用原子操作。将帮助读者更好地理解和利用 GPU 的强大计算能力。"><meta property='og:url' content='https://cuterwrite.top/p/cuda-tutorial/'><meta property='og:site_name' content="Cuterwrite's Blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='并行计算'><meta property='article:tag' content='CUDA'><meta property='article:published_time' content='2023-07-11T00:00:00+00:00'><meta property='article:modified_time' content='2023-07-11T00:00:00+00:00'><meta property='og:image' content='https://cuterwrite-1302252842.file.myqcloud.com/img/ba25bc69cbefbfac1287056fee570cee2b6458ff.jpg@1256w_880h_!web-article-pic.avif'><meta name=twitter:title content="CUDA 编程：从基础到应用"><meta name=twitter:description content="本文深入解析了 CUDA 编程，从介绍 CUDA 的基本概念开始，探讨 CPU 与 GPU 的差异，详述异构计算的理念。进一步，我们将深入 CUDA 编程模型，讲解 CUDA 线程执行模型，以及如何在 CUDA 中使用原子操作。将帮助读者更好地理解和利用 GPU 的强大计算能力。"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://cuterwrite-1302252842.file.myqcloud.com/img/ba25bc69cbefbfac1287056fee570cee2b6458ff.jpg@1256w_880h_!web-article-pic.avif'><link rel="shortcut icon" href=/favicon.ico><script async src=https://analytics.cuterwrite.top/uma data-website-id=635c2011-51a9-4ffc-b360-f5572bb94276 data-domains=cuterwrite.top></script><link rel=manifest href=/manifest.json></head><body class="article-page
line-numbers"><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hue4d14694a57c01a222a16c47db12c89c_369633_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>😉</span></figure><div class=site-meta><h1 class=site-name><a href=/>Cuterwrite's Blog</a></h1><h2 class=site-description>Cuterwrite 的技术博客, 专注于高性能计算、操作系统、全栈开发、人工智能等领域的深度探讨和经验分享。</h2></div></header><ol class=menu-social><li><a href=https://analytics.cuterwrite.top/share/WcwRpn3giAassmyW/cuterwrite target=_blank title=Analytics rel=me><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 5H7A2 2 0 005 7v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="2"/><path d="M9 17v-5"/><path d="M12 17v-1"/><path d="M15 17v-3"/></svg></a></li><li><a href=https://status.cuterwrite.top target=_blank title=Upptime rel=me><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-chart-line"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 19h16"/><path d="M4 15l4-6 4 2 4-5 4 4"/></svg></a></li><li><a href=/index.xml target=_blank title=RSS rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li><li><a href=https://github.com/PKUcoldkeyboard target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://www.zhihu.com/people/kong-tiao-cheng-tai-lang-30-57 target=_blank title=zhihu rel=me><svg t="1705591931290" class="icon" viewBox="0 0 1280 1024" xmlns="http://www.w3.org/2000/svg" p-id="21048" width="32" height="32"><path d="M341.08 296.26v435.08l46.86.02 15.42 52.74 84.02-52.74h99.06V296.26H341.08zm195.5 387.86H480.7l-55.8 35.02-10.16-34.94-23.8-.08V343.5h145.64v340.62zM299.66 495.34H195c3.48-54.2 4.4-103.18 4.4-146.92h102.32s3.94-45.12-17.16-44.62h-177c6.98-26.24 15.74-53.32 26.24-81.34.0.0-48.14.0-64.54 43.14-6.78 17.8-26.42 86.28-61.4 156.24 11.78-1.28 50.74-2.36 73.68-44.42 4.22-11.78 5.02-13.32 10.28-29.06h57.74c0 21-2.4 133.76-3.36 146.88H41.66c-23.48.0-31.12 47.24-31.12 47.24H141.7C132.9 642.2 85.66 726.24.0 792.68c40.98 11.7 81.82-1.86 102-19.8.0.0 45.96-41.8 71.18-138.5L281.1 764.26s15.82-53.78-2.48-79.98c-15.16-17.84-56.12-66.12-73.58-83.62L175.8 623.9c8.72-27.96 13.98-55.1 15.74-81.34h123.3s-.18-47.24-15.18-47.24v.02zm824.04-3.2c41.66-51.28 89.96-117.14 89.96-117.14s-37.3-29.6-54.76-8.12c-12 16.3-73.66 96.4-73.66 96.4l38.46 28.86zM823.52 373.96c-18.02-16.5-51.82 4.26-51.82 4.26s79.04 110.08 82.24 114.9l38.92-27.46s-51.34-75.22-69.32-91.72h-.02zM1280 516.7c-39.56.0-261.82 1.86-262.12 1.86v-202c9.62.0 24.84-.8 45.7-2.4 81.76-4.82 140.26-8 175.54-9.62.0.0 24.44-54.38-1.18-66.88-6.14-2.36-46.34 9.16-46.34 9.16s-330.44 32.98-464.72 36.1c3.2 17.64 15.24 34.16 31.56 39.1 26.62 6.96 45.38 3.4 98.3 1.78 49.66-3.2 87.36-4.86 113.02-4.86v199.62H702.82s5.64 44.62 51.02 45.7h215.88V706.1c0 27.94-22.38 43.98-48.96 42.24-28.16.22-52.16-2.3-83.38-3.62 3.98 7.94 12.66 28.78 38.62 43.68 19.76 9.62 32.34 13.14 52.04 13.14 59.12.0 91.34-34.56 89.78-90.62V564.28h244.72c19.36.0 17.4-47.56 17.4-47.56l.06-.02z" fill="#707070" p-id="21049"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>主页 | Home</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>关于 | About</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档 | Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索 | Search</span></a></li><li><a href=https://cuterwrite.top/image-hosting target=_blank><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-album"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 4m0 2a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2z"/><path d="M12 4v7l2-2 2 2V4"/></svg>
<span>图册 | Gallery</span></a></li><li><a href=https://draw.cuterwrite.top target=_blank><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-artboard"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M8 8m0 1a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H9a1 1 0 01-1-1z"/><path d="M3 8h1"/><path d="M3 16h1"/><path d="M8 3v1"/><path d="M16 3v1"/><path d="M20 8h1"/><path d="M20 16h1"/><path d="M8 20v1"/><path d="M16 20v1"/></svg>
<span>画板 | Canvas</span></a></li><li><a href=https://it-tools.tech target=_blank><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-tools"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 21h4L20 8a1.5 1.5.0 00-4-4L3 17v4"/><path d="M14.5 5.5l4 4"/><path d="M12 8 7 3 3 7l5 5"/><path d="M7 8 5.5 9.5"/><path d="M16 12l5 5-4 4-5-5"/><path d="M16 17l-1.5 1.5"/></svg>
<span>工具 | Tools</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ul><li><a href=#一什么是-cuda>一、什么是 CUDA</a></li><li><a href=#二cpu-vs-gpu>二、CPU vs. GPU</a></li><li><a href=#三异构计算>三、异构计算</a></li><li><a href=#四cuda-编程模型>四、CUDA 编程模型</a></li><li><a href=#五cuda-线程执行模型>五、CUDA 线程执行模型</a></li><li><a href=#六cuda-原子操作>六、CUDA 原子操作</a></li></ul></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/cuda-tutorial/><img src=https://cuterwrite-1302252842.file.myqcloud.com/img/ba25bc69cbefbfac1287056fee570cee2b6458ff.jpg@1256w_880h_!web-article-pic.avif loading=lazy alt="Featured image of post CUDA 编程：从基础到应用"></a></div><div class=article-details><header class=article-category><a href=/categories/hpc/ style=background-color:#ffb900;color:#fff>高性能计算</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/cuda-tutorial/>CUDA 编程：从基础到应用</a></h2><h3 class=article-subtitle>本文深入解析了 CUDA 编程，从介绍 CUDA 的基本概念开始，探讨 CPU 与 GPU 的差异，详述异构计算的理念。进一步，我们将深入 CUDA 编程模型，讲解 CUDA 线程执行模型，以及如何在 CUDA 中使用原子操作。将帮助读者更好地理解和利用 GPU 的强大计算能力。</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2023-07-11</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 8 分钟</time></div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-keyboard"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M2 6m0 2a2 2 0 012-2h16a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2z"/><path d="M6 10v.01"/><path d="M10 10v.01"/><path d="M14 10v.01"/><path d="M18 10v.01"/><path d="M6 14v.01"/><path d="M18 14v.01"/><path d="M10 14l4 .01"/></svg>
<time class=article-time--wordcount>字数统计: 3944 字</time></div></footer></div></header><section class=article-content><h1 id=cuda-编程从基础到应用>CUDA 编程：从基础到应用</h1><h2 id=一什么是-cuda>一、什么是 CUDA</h2><ul><li>CUDA 是 NVIDIA 推出的一种通用并行计算平台和编程模型，可以利用 GPU 的强大计算能力来加速各种应用程序。</li><li>CUDA 的优势在于：<ul><li>提供了一套简单易用的编程接口，支持 C/C++/Fortran/Python 等多种语言。</li><li>兼容各种操作系统，如 Windows/Linux/MacOS 等。</li><li>支持多种 GPU 架构，如 Tesla/Fermi/Kepler/Maxwell/Pascal/Volta/Turing/Ampere 等。</li><li>支持多种并行编程模式，如数据并行/任务并行/流并行等。</li><li>支持多种优化技术，如共享内存/纹理内存/常量内存/原子操作/同步机制等。</li></ul></li><li>Why CUDA?<ul><li>串行速度提升已经结束<ul><li>无法继续提升频率</li><li>难以继续降低功耗</li></ul></li><li>当前计算机性能提升趋势<ul><li>计算机没有变得更快，而是变得更宽<ul><li>多核 CPU、GPU、超级计算机</li></ul></li><li>数据级别并行<ul><li>同样的指令作用于多个数据</li></ul></li><li>线程级别的并行</li></ul></li></ul></li></ul><h2 id=二cpu-vs-gpu>二、CPU vs. GPU</h2><ul><li>CPU 和 GPU 都是计算机中的重要组件，但它们有着不同的设计目标和特点。</li><li>CPU 的特点是：<ul><li>拥有较少的核心数，但每个核心都有较高的时钟频率和较强的运算能力。</li><li>拥有较大的缓存和复杂的控制流机制，可以有效地降低延迟和提高串行代码的性能。</li><li>更适合于处理复杂的单任务或少量的多任务，如操作系统/数据库/编译器等。</li><li>类比于摩托车，可以灵活地在城市中穿梭。</li></ul></li><li>GPU 的特点是：<ul><li>拥有较多的核心数，但每个核心都有较低的时钟频率和较弱的运算能力。</li><li>拥有较小的缓存和简单的控制流机制，可以有效地提高吞吐量和利用大规模并行架构。</li><li>更适合于处理大量相似或简单的任务，如图形渲染/科学计算/机器学习等。</li><li>类比于大巴车，可以承载更多的乘客。</li></ul></li></ul><div class=table-wrapper><table><thead><tr><th></th><th>CPU</th><th>GPU</th></tr></thead><tbody><tr><td>缓存</td><td>大缓存：掩盖较长的存储器延迟</td><td>小缓存：但通过更快的存储提高吞吐量</td></tr><tr><td>运算器</td><td>强大的运算器：降低运算延迟</td><td>更节能的运算器：延迟大但总吞吐量大</td></tr><tr><td>控制机制</td><td>复杂的控制机制：分支预测等</td><td>简单的控制流机制：无分支预测</td></tr><tr><td>线程</td><td>线程高度轻量级：大量并发</td><td>线程高度轻量级：大量并发</td></tr></tbody></table></div><h2 id=三异构计算>三、异构计算</h2><ul><li>异构计算是指利用不同类型的处理器协同工作来完成一个任务，如 CPU+GPU、CPU+FPGA、CPU+ASIC 等。</li><li>异构计算的优势在于：<ul><li>可以充分发挥每种处理器的特长，提高性能和效率。</li><li>可以降低功耗和成本，延长设备寿命和节约资源。</li><li>可以增加灵活性和可扩展性，适应不同场景和需求。</li></ul></li><li>异构计算的挑战在于：<ul><li>需要设计合适的编程模型和接口，实现不同处理器之间的协调和通信。</li><li>需要考虑不同处理器之间的负载均衡和数据一致性，避免性能瓶颈和错误发生。</li><li>需要优化不同处理器之间的数据传输和转换，减少开销和延迟。</li></ul></li><li>CPU+GPU<ul><li>利用 CPU 处理复杂控制流</li><li>利用 GPU 处理大规模运算</li><li>CPU 与 GPU 之间通过 PCIe 总线通信<ul><li>新显卡支持 NVLink 连接（5-12 倍 PCIe3.0)</li></ul></li></ul></li></ul><h2 id=四cuda-编程模型>四、CUDA 编程模型</h2><ul><li><p>CUDA 编程模型是基于数据并行思想设计的一种分层抽象模型，可以将一个复杂的问题分解为多个简单的子问题，并将其映射到 GPU 上执行。</p></li><li><p>CUDA 编程模型包括以下几个层次：</p><ul><li>线程（thread）：线程是 CUDA 中最基本的执行单元，每个线程都有自己独立的寄存器、指令指针、栈空间等。</li><li>块（block）：块是由多个线程组成的一维或二维的逻辑分组，每个块都有自己独立的共享内存、同步机制等。</li><li>网格（grid）：网格是由多个块组成的一维或二维的逻辑分组，每个网格都有自己独立的全局内存、常量内存、纹理内存等。</li><li>设备（device）：设备是指 GPU 本身，包括多个流式处理器（SM）、多个 CUDA 核心（core）、多个缓存、总线等。</li><li>主机（host）：主机是指 CPU 本身，包括内存、硬盘、键盘、鼠标等。</li></ul></li><li><p>CUDA 编程模型的执行流程如下：</p><ul><li>在主机端编写并行代码，称为核函数（kernel），并使用<code>__global__</code>修饰符标记。</li><li>在主机端调用核函数，并使用<code>&lt;&lt;&lt; grid,block >>></code>语法指定网格和块的维度，称为执行配置。</li><li>在设备端执行核函数，每个块被分配到一个 SM 上，每个线程被分配到一个 core 上。</li><li>在设备端完成核函数后，返回主机端继续执行后续代码。</li></ul></li><li><p>2 级架构</p><ul><li>每个 GPU 拥有多个 Streaming Multiprocessor(SM)<ul><li>具体数目及设计因产品而异</li><li>SM 共用显存</li></ul></li><li>每个 SM 拥有多个 CUDA core<ul><li>数目因产品而异</li><li>Core 共用调度器和指令缓存</li></ul></li></ul></li><li><p>2 级架构下的执行模型：线程束（warp）</p><ul><li>CUDA 线程以 32 个为一组在 GPU 上执行<ul><li>线程束以单指令多线程的方式运行（SIMT）<ul><li>所有线程在不同数据上执行相同的指令</li></ul></li></ul></li><li>SMIT、SIMD、SMT<ul><li>灵活度：SIMD &lt; SIMT &lt; SMT</li><li>性能： SIMD > SIMT > SMT</li><li>SIMT 与 SIMD 相比：多个状态寄存器，多个地址，独立的执行路径</li></ul></li><li>SM 负责调度并执行线程束<ul><li>线程束调度时会产生上下文切换</li><li>调度方式因架构而异</li></ul></li></ul></li><li><p>Host 与 device</p><ul><li>Host（CPU）相关：运行在 CPU 上的代码及主机内存</li><li>Device（GPU）相关：运行在 GPU 上的代码及显存（设备内存）</li><li>通过在主机上调用核函数（kernel）执行并行代码</li></ul></li><li><p>指明 host 与 device 代码</p><ul><li><code>__host__</code>从主机端调用，在主机端执行</li><li><code>__global__</code>从主机端调用，在设备端执行</li><li><code>__device__</code>从设备端调用，在设备端执行</li><li><code>__host__</code>和<code>__device__</code>可以一起使用</li><li><code>&lt;&lt;&lt; 1,4 >>></code>：执行配置<ul><li>指明网格中有 1 个块</li><li>每块中有 4 个线程</li></ul></li><li>cudaDeviceSynchronize()<ul><li>与 OpenMP 不同，CUDA 核函数为异步执行</li></ul></li><li>核函数限制条件（<code>__global__</code>函数）<ul><li>只能访问设备内存</li><li>必须返回 void</li><li>不支持可变数量的参数</li><li>参数不可为引用类型</li><li>不支持静态变量</li></ul></li></ul></li><li><p>指明网格及块的维度</p><ul><li>形式为<code>&lt;&lt;&lt; grid,block >>></code><ul><li>grid 与 block 为 dim3 类型</li><li>grid 与 block 的大小受到计算能力的限制</li></ul></li></ul><figure><img src=https://cuterwrite-1302252842.file.myqcloud.com/blog/grid-of-thread-blocks.webp alt=grid-of-thread-blocks width=auto loading=lazy></figure><ul><li>GPU 架构与线程执行<ul><li>一个 CUDA core 执行一个线程</li><li>一个 SM 执行一个 block 中的线程</li><li>GPU 中执行 grid 中的所有线程</li></ul></li><li>确定线程编号<ul><li>使用内置变量 threadIdx、blockIdx、blockDim</li></ul></li><li>CUDA 编程例子：向量加法<pre><code class=language-c>__global__ void VecAdd(int *a, int *b, int *c)
{
  int tid = blockIdx.x;
  if (tid &lt; N) {
    c[tid] = a[tid] + b[tid];
  }
}
int main()
{
    ...
    // Kernel invocation with N threads
    VecAdd&lt;&lt;&lt;1, N&gt;&gt;&gt;(A, B, C);
    ...
}
</code></pre></li></ul></li><li><p>GPU 内存管理：</p><ul><li>创建：cudaMalloc</li><li>拷贝：cudaMemcpy<ul><li>使用 cudaMemcpyHostToDevice 与 cudaMemcpyDeviceToHost 指明拷贝方向</li></ul></li><li>释放：cudaFree</li></ul></li><li><p>处理错误</p><ul><li>使用宏定义</li></ul></li><li><p>block 中最大线程限制：n 必须不大于 1024</p></li><li><p>同一个 block 只在一个 SM 上执行：没有充分利用 GPU 计算资源</p></li><li><p>思路：使用多个 block</p><ul><li>每个 block 使用 m 个 thread（如 m=32）</li><li>grid,block 设置：<code>&lt;&lt;&lt; n/m, m >>></code><ul><li>n 无法被 m 整除？</li><li>需对 n/m 向上取整</li><li>需判断 tid 是否会超过范围</li></ul></li><li>确定 thread 的全局编号</li></ul></li></ul><h2 id=五cuda-线程执行模型>五、CUDA 线程执行模型</h2><ul><li>逻辑视图<ul><li>每个线程块由一个 SM 执行</li><li>由硬件调度</li><li>无法控制线程块的执行顺序</li></ul></li><li>硬件视图<ul><li>所有线程块在硬件上都是一维的</li><li>三维线程将沿 x->y->z 的顺序展开到一维</li><li>展开后的一维线程每 32 个形成一个线程束<ul><li>最后不足 32 的部分也将创建线程<ul><li>不活跃</li><li>仍将消耗 SM 资源</li></ul></li></ul></li></ul></li><li>线程束调度<ul><li>线程束切换开销为 0<ul><li>SM 保存每个线程束的执行上下文</li><li>在整个线程束的生命周期中保存于芯片内</li><li>上下文切换没有损失</li><li>可切换同一 SM 上不同线程块的线程束</li></ul></li><li>SM 中常驻线程块数量受可用资源限制<ul><li>资源：程序计数器、寄存器、共享内存</li><li>活跃线程束：具备计算资源的线程束<ul><li>Kepler 上最大为 64</li><li>选定的线程束：被调度到执行单元的线程束（Kepler 上最大为 4）</li><li>符合条件的线程束：准备执行但尚未执行</li><li>阻塞的线程束：没做好执行准备（指令参数未就绪，无可用 CUDA core）</li></ul></li></ul></li><li>活跃线程束于延迟隐藏<ul><li>满载：线程调度器在每个时钟周期都有符合条件的线程束</li><li>通过调度符合条件的线程束，可以有效的掩盖指令延迟<ul><li>算数指令：算数操作从开始到产生输出（10~20 时钟周期）</li><li>内存指令：发出加载/存储操作到数据到达目的地（全局内存~800 时钟周期）</li></ul></li><li>应适当增加活跃线程束<ul><li>Little&rsquo;s law</li><li>线程数不宜过少（每个线程处理的任务数与线程数需要平衡）</li><li>线程块资源不易过多（如，共享内存的大小与活跃线程块数量需要平衡）</li></ul></li></ul></li></ul></li><li>线程束执行<ul><li>每个线程束以 SIMD 方式在 SM 上执行<ul><li>线程束内同时执行同样语句</li><li>线程束外的视角看来为 SIMT</li></ul></li><li>分支分化<ul><li>线程束出现不同的控制流</li><li>性能优化：避免分支分化，因为线程束只能执行相同的逻辑，在执行某一个路径的线程时会禁用另一路径的线程。</li></ul></li><li>busy waiting vs signal<ul><li>busy waiting：如，使用 while 循环不断检查条件是否满足</li><li>signal：当条件满足由系统发送指令<ul><li>__syncthreads()：只能在线程块内同步，不能在不同的线程块同步</li></ul></li><li>busy waiting 的问题：死锁</li></ul></li><li>减少分支分化的影响<ul><li>减少 if 语句<ul><li>尤其是减少基于 threadIdx 的 if 语句</li><li>使用条件赋值代替条件语句</li></ul></li><li>平衡分支执行时间<ul><li>避免出现执行时间过长的分支</li></ul></li></ul></li></ul></li></ul><h2 id=六cuda-原子操作>六、CUDA 原子操作</h2><ul><li>原子指令<ul><li>执行过程不能分解为更小的部分：不被中断</li><li>避免竞争条件出现</li><li>竞争条件<ul><li>程序运行结果依赖于不可控的执行顺序</li></ul></li></ul></li><li>CUDA 原子操作：<ul><li>基本操作：atomicCAS<ul><li>其它所有原子操作均可由 atomicCAS()实现</li><li>CAS：compare and swap<ul><li>读取目标位置(address)并与预期值(old_val)进行比较<ul><li>相等则将 new_val 写入目标位置</li><li>不相等则不发生变化</li></ul></li><li>返回目标位置中原值：可用来检查 CAS 操作是否成功</li></ul></li></ul></li></ul></li><li>原子指令与并发控制：原子指令在并发控制中起着重要的作用。在多线程或多进程的环境中，当多个线程或进程尝试同时访问和修改共享数据时，如果没有适当的控制机制，可能会导致数据的不一致性。原子指令通过确保某些操作在执行过程中不会被其他线程或进程中断，来避免这种情况。</li><li>竞争条件与死锁：竞争条件是并发编程中的一个主要问题，它发生在两个或更多的线程或进程在无序或未同步的情况下访问和修改共享数据，导致结果不可预测。原子指令是解决竞争条件的一种方法，但也可能引入另一个问题 - 死锁。死锁是指两个或更多的进程或线程互相等待对方释放资源，导致所有进程或线程都无法继续执行。</li><li>CUDA 原子操作与 GPU 编程：在 GPU 编程中，由于大量的线程并行执行，可能会有多个线程同时访问和修改同一块内存。CUDA 的原子操作提供了一种机制，使得在这种情况下仍能保证数据的一致性。然而，过度依赖原子操作可能会导致性能下降，因为它们违反了 GPU 编程的基本原则——并行执行。因此，在设计 GPU 算法时，应尽量减少原子操作的使用，或者寻找可以避免使用原子操作的算法。</li><li>CUDA 原子操作的应用：在某些情况下，CUDA 原子操作是必要的。例如，在统计或计数问题中，需要多个线程共享一个计数器，并且每个线程都可能需要增加计数器的值。在这种情况下，使用 CUDA 原子操作可以保证计数器的正确性。另一个例子是图形处理，其中可能需要多个线程同时更新像素的值。使用 CUDA 原子操作可以避免同时更新导致的数据不一致问题。</li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/parallel-computing/>并行计算</a>
<a href=/tags/cuda/>CUDA</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer><script type=text/javascript src=/js/prism.js async></script></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/cuda-base-memory-access-mode/><div class=article-image><img src=https://cuterwrite-1302252842.file.myqcloud.com/img/14ce26d6f495200cea2cfa76fefadf88eaab94e5.jpg@1256w_754h_!web-article-pic-2023-09-04.webp loading=lazy data-key=cuda-base-memory-access-mode data-hash=https://cuterwrite-1302252842.file.myqcloud.com/img/14ce26d6f495200cea2cfa76fefadf88eaab94e5.jpg@1256w_754h_!web-article-pic-2023-09-04.webp></div><div class=article-details><h2 class=article-title>CUDA 基础：内存访问模式</h2></div></a></article><article class=has-image><a href=/p/cuda-base-memory-manage/><div class=article-image><img src=https://cuterwrite-1302252842.file.myqcloud.com/blog/fb80f7f3a9a0e016420a324823ef950b9847fb8d.jpg@1256w_2128h_!web-article-pic-2023-09-02.webp loading=lazy data-key=cuda-base-memory-manage data-hash=https://cuterwrite-1302252842.file.myqcloud.com/blog/fb80f7f3a9a0e016420a324823ef950b9847fb8d.jpg@1256w_2128h_!web-article-pic-2023-09-02.webp></div><div class=article-details><h2 class=article-title>CUDA 基础：内存管理</h2></div></a></article><article class=has-image><a href=/p/cuda-base-memory-model/><div class=article-image><img src=https://cuterwrite-1302252842.file.myqcloud.com/blog/47a9b8a012cf3a3f552c9aba3aeaa93fe669cf70.jpg@1256w_970h_!web-article-pic-2023-09-01.webp loading=lazy data-key=cuda-base-memory-model data-hash=https://cuterwrite-1302252842.file.myqcloud.com/blog/47a9b8a012cf3a3f552c9aba3aeaa93fe669cf70.jpg@1256w_970h_!web-article-pic-2023-09-01.webp></div><div class=article-details><h2 class=article-title>CUDA 基础：内存模型概述</h2></div></a></article><article class=has-image><a href=/p/cuda-base-warp/><div class=article-image><img src=https://cuterwrite-1302252842.file.myqcloud.com/blog/20230831184001-2023-08-31.webp loading=lazy data-key=cuda-base-warp data-hash=https://cuterwrite-1302252842.file.myqcloud.com/blog/20230831184001-2023-08-31.webp></div><div class=article-details><h2 class=article-title>CUDA 基础：线程束执行的本质</h2></div></a></article><article class=has-image><a href=/p/openmp-intro/><div class=article-image><img src=https://cuterwrite-1302252842.file.myqcloud.com/img/c17b7451a44c1d4370d5ba2b966298ea195413_crop-2024-02-19.webp loading=lazy data-key=openmp-intro data-hash=https://cuterwrite-1302252842.file.myqcloud.com/img/c17b7451a44c1d4370d5ba2b966298ea195413_crop-2024-02-19.webp></div><div class=article-details><h2 class=article-title>OpenMP 简介</h2></div></a></article></div></div></aside><script src=https://cdn.bootcdn.net/ajax/libs/twikoo/1.6.20/twikoo.all.min.js></script><div id=tcomment></div><style>.twikoo{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}:root[data-scheme=dark]{--twikoo-body-text-color-main:rgba(255, 255, 255, 0.9);--twikoo-body-text-color:rgba(255, 255, 255, 0.7)}.twikoo .el-input-group__prepend,.twikoo .tk-action-icon,.twikoo .tk-time,.twikoo .tk-comments-count{color:var(--twikoo-body-text-color)}.twikoo .el-input__inner,.twikoo .el-textarea__inner,.twikoo .tk-preview-container,.twikoo .tk-content,.twikoo .tk-nick,.twikoo .tk-send{color:var(--twikoo-body-text-color-main)}.twikoo .el-button{color:var(--twikoo-body-text-color)!important}.OwO .OwO-body{background-color:var(--body-background)!important;color:var(--body-text-color)!important}</style><script>twikoo.init({envId:"https://comment.cuterwrite.top",el:"#tcomment",lang:"zh-CN"})</script><footer class=site-footer><section class=copyright>&copy;
2021 -
2024 cuterwrite</section><section class=running-time>本博客已稳定运行
<span id=runningdays class=running-days></span></section><section class=totalcount>发表了71篇文章 ·
总计303.44k字</section><section class=powerby>Welcome to cuterwrite's blog!<br>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.17.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计<br><span>基于 <a href=https://github.com/CaiJimmy/hugo-theme-stack/tree/v3.25.0 target=_blank rel=noopener><b style=color:#9e8f9f>v3.25.0</b></a> 分支版本修改</span><br></section></footer><script>let s1="2021-4-17";s1=new Date(s1.replace(/-/g,"/"));let s2=new Date,timeDifference=s2.getTime()-s1.getTime(),days=Math.floor(timeDifference/(1e3*60*60*24)),hours=Math.floor(timeDifference%(1e3*60*60*24)/(1e3*60*60)),minutes=Math.floor(timeDifference%(1e3*60*60)/(1e3*60)),result=days+"天"+hours+"小时"+minutes+"分钟";document.getElementById("runningdays").innerHTML=result</script><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.bootcdn.net/ajax/libs/photoswipe/4.1.3/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.bootcdn.net/ajax/libs/photoswipe/4.1.3/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.bootcdn.net/ajax/libs/photoswipe/4.1.3/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.bootcdn.net/ajax/libs/photoswipe/4.1.3/photoswipe.min.css crossorigin=anonymous></main></div><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.font.im/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><meta name=apple-mobile-web-app-capable content="yes"><meta name=theme-color content="#ffffff"><script>"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js").then(e=>{console.log("Service worker registered with scope: ",e.scope)},e=>{console.log("Service worker registration failed: ",e)})})</script></body></html>